<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GNC SALES COMMAND</title>
    
    <meta name="theme-color" content="#007a4d">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="GNC LOGO.png">
    <link rel="apple-touch-icon" href="GNC LOGO.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        :root { --brand-green: #007a4d; --text-main: #111827; }
        body { font-family: "Amazon Ember", Arial, sans-serif; background-color: white; color: var(--text-main); overscroll-behavior-y: contain; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; }
        .nav-header { background: var(--brand-green); color: white; padding-top: max(10px, env(safe-area-inset-top)); }
        
        /* LOGIN STYLES */
        #view-login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--brand-green); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 360px; text-align: center; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 15px; margin-bottom: 12px; }

        /* TOAST */
        #toast-notification { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: #16a34a; color: white; padding: 16px 24px; border-radius: 50px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); z-index: 11000; transition: top 0.5s; display: flex; align-items: center; gap: 12px; pointer-events: none; }
        #toast-notification.show { top: 20px; }
        
        /* SIDEBAR */
        #side-drawer { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: white; z-index: 2000; box-shadow: 2px 0 10px rgba(0,0,0,0.2); transition: left 0.3s; }
        #side-drawer.open { left: 0; }
        #drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; display: none; }
        #drawer-overlay.open { display: block; }
        .drawer-header { background: var(--brand-green); color: white; padding: 20px; font-weight: bold; font-size: 18px; }
        .drawer-item { padding: 16px 20px; border-bottom: 1px solid #f3f4f6; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #374151; font-weight: 500; }

        /* CARDS & UI */
        .drill-item { border-bottom: 1px solid #e5e7eb; padding: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: white; transition: background 0.1s; user-select: none; }
        .drill-item:active { background: #f3f4f6; }
        .back-btn { display: flex; align-items: center; gap: 5px; color: #6b7280; font-size: 14px; font-weight: 600; margin-bottom: 20px; cursor: pointer; padding: 10px 0; }

        .inv-card { border: 1px solid #e5e7eb; border-left-width: 6px; border-radius: 8px; padding: 12px; background: white; cursor: pointer; flex-grow: 1; }
        .status-green { border-left-color: #22c55e; } 
        .status-purple { border-left-color: #9333ea; } 
        .status-orange { border-left-color: #f97316; } 
        .status-blue { border-left-color: #3b82f6; }
        
        .task-tabs { display: flex; border-bottom: 1px solid #e5e7eb; background: #f9fafb; margin-bottom: 10px; }
        .task-tab { flex: 1; text-align: center; padding: 12px; font-size: 11px; font-weight: 700; color: #6b7280; cursor: pointer; border-bottom: 3px solid transparent; text-transform: uppercase; }
        .task-tab.active { color: var(--brand-green); border-bottom-color: var(--brand-green); background: white; }

        .detail-tabs { display: flex; border-bottom: 1px solid #e5e7eb; background: #f9fafb; margin-bottom: 10px; }
        .detail-tab { flex: 1; text-align: center; padding: 10px; font-size: 11px; font-weight: 700; color: #6b7280; cursor: pointer; border-bottom: 3px solid transparent; text-transform: uppercase; }
        .detail-tab.active { color: var(--brand-green); border-bottom-color: var(--brand-green); background: white; }
        
        .overview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
        .overview-card { background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0; }
        .overview-label { font-size: 9px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 2px; }
        .overview-val { font-size: 13px; font-weight: 600; color: #0f172a; word-break: break-all; }
        .full-width { grid-column: span 2; }

        /* ACCORDION EXPAND STYLES */
        .expand-trigger { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; border: 1px solid #e5e7eb; }
        .expand-content { display: none; margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb; }
        .expanded .expand-content { display: block; }

        /* MULTI-SELECT ANIMATION STYLES */
        .card-checkbox-container { width: 0; overflow: hidden; opacity: 0; transition: width 0.3s, opacity 0.3s, margin 0.3s; }
        body.multi-select-mode .card-checkbox-container { width: 24px; opacity: 1; margin-right: 12px; }
        .item-row { user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; }

        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">

    <div id="toast-notification"></div>

    <div id="view-login">
        <div class="login-card">
            <div class="text-3xl text-[#007a4d] font-bold mb-6">GNC SALES COMMAND</div>
            <div id="login-inputs">
                <input type="text" id="username-input" class="input-field mb-4 text-center border-2" placeholder="USERNAME">
                <input type="password" id="pin-code" class="input-field mb-4 text-center border-2 tracking-widest" placeholder="PASSWORD">
                <button class="w-full bg-[#007a4d] text-white font-bold py-3 rounded-lg shadow-md" onclick="handleLogin()">LOGIN</button>
                
                <button id="btn-fingerprint" class="hidden w-full bg-gray-50 text-[#007a4d] border-2 border-[#007a4d] font-bold py-3 rounded-lg shadow-md mt-4 flex items-center justify-center gap-2" onclick="loginWithBiometric()">
                    <i class="ph-bold ph-fingerprint text-2xl"></i> LOGIN WITH FINGERPRINT
                </button>
            </div>
            <div id="loading-spinner" class="hidden mt-6 flex flex-col items-center">
                <div class="spinner"></div>
                <div id="loading-text" class="text-white font-bold text-sm mt-3 text-center">Authenticating & Syncing...</div>
            </div>
        </div>
    </div>

    <div id="tab-select-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <h3 class="font-bold text-lg mb-4 text-[#007a4d]">Which data to use?</h3>
            <div class="grid grid-cols-1 gap-3 mb-4">
                <button class="bg-green-50 text-green-700 font-bold p-4 rounded-lg border border-green-200 shadow-sm" onclick="processTabSelection('notes')">NOTES & ACTIONS</button>
                <button class="bg-purple-50 text-purple-700 font-bold p-4 rounded-lg border border-purple-200 shadow-sm" onclick="processTabSelection('request')">REQUEST DATA</button>
            </div>
            <button class="text-gray-500 font-bold py-2 px-4" onclick="document.getElementById('tab-select-modal').classList.add('hidden')">Cancel</button>
        </div>
    </div>

    <div id="assign-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <h3 class="font-bold text-lg mb-4 text-[#007a4d]">Assign Selected Items To:</h3>
            <div class="grid grid-cols-1 gap-3 mb-4">
                <button class="bg-blue-50 text-blue-700 font-bold p-4 rounded-lg border border-blue-200 shadow-sm" onclick="confirmAssign('Dylan')">Dylan</button>
                <button class="bg-blue-50 text-blue-700 font-bold p-4 rounded-lg border border-blue-200 shadow-sm" onclick="confirmAssign('Kayla')">Kayla</button>
                <button class="bg-blue-50 text-blue-700 font-bold p-4 rounded-lg border border-blue-200 shadow-sm" onclick="confirmAssign('Morgan')">Morgan</button>
            </div>
            <button class="text-gray-500 font-bold py-2 px-4" onclick="closeAssignModal()">Cancel</button>
        </div>
    </div>

    <div id="request-rep-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <h3 class="font-bold text-lg mb-4 text-orange-600">Who requested this?</h3>
            
            <div class="grid grid-cols-1 gap-3 mb-4 max-h-[60vh] overflow-y-auto px-2 py-1">
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Abbey Burka')">Abbey Burka</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Annette Hancock')">Annette Hancock</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Ben Brown')">Ben Brown</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Ben Harveson')">Ben Harveson</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Ben Machino')">Ben Machino</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Brian Hatfield')">Brian Hatfield</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Casey Rufener')">Casey Rufener</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Chris Farrow')">Chris Farrow</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Chris Gaydos')">Chris Gaydos</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('David Brandt')">David Brandt</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Ellen Deely')">Ellen Deely</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Jessica Robertson')">Jessica Robertson</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Josh Ringleb')">Josh Ringleb</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Kevin Effinger')">Kevin Effinger</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Nate Douglas')">Nate Douglas</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Toby Brown')">Toby Brown</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Traci Earle')">Traci Earle</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Tracey Tapscott')">Tracey Tapscott</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Troy Lee')">Troy Lee</button>
                <button class="bg-orange-50 text-orange-700 font-bold p-4 rounded-lg border border-orange-200 shadow-sm" onclick="confirmRequestAction('Wes Lugas')">Wes Lugas</button>
            </div>
            
            <button class="text-gray-500 font-bold py-2 px-4" onclick="document.getElementById('request-rep-modal').classList.add('hidden')">Cancel</button>
        </div>
    </div>

    <div id="app-wrapper" class="hidden h-full flex flex-col">
        <header class="nav-header sticky top-0 z-50 p-4 flex justify-between items-center shadow-md">
            <div class="flex items-center gap-3">
                <i class="ph-bold ph-list menu-btn text-2xl cursor-pointer" onclick="toggleMenu()"></i>
                <div class="flex flex-col">
                    <div class="font-bold text-lg leading-tight"><span id="header-user">User</span></div>
                    <div class="text-[10px] opacity-80 leading-tight">GNC SALES COMMAND</div>
                </div>
            </div>
        </header>

        <div id="drawer-overlay" onclick="toggleMenu()"></div>
        <div id="side-drawer">
            <div class="drawer-header">Menu</div>
            <div class="drawer-item" onclick="switchView('home'); toggleMenu();"><i class="ph-bold ph-house"></i> Home</div>
            <div class="drawer-item" onclick="switchView('drive'); toggleMenu();"><i class="ph-bold ph-car"></i> Drive Mode</div>
            <div class="drawer-item" onclick="switchView('tasks'); toggleMenu();"><i class="ph-bold ph-clipboard-text"></i> My Tasks</div>
            <div class="drawer-item text-orange-600 font-bold" onclick="switchView('docks'); toggleMenu();"><i class="ph-bold ph-truck"></i> Docks</div>
            
            <hr class="my-2">
            <div class="drawer-item text-blue-600 font-bold admin-only" onclick="switchView('request'); toggleMenu();"><i class="ph-bold ph-chat-circle-text"></i> Requests</div>
            <div class="drawer-item text-purple-600 font-bold admin-only" onclick="switchView('sales-office'); toggleMenu();"><i class="ph-bold ph-briefcase"></i> Sales Office</div>
            <div class="drawer-item text-red-600 font-bold admin-only" onclick="switchView('low-stock'); toggleMenu();"><i class="ph-bold ph-trend-down"></i> Low Stock List</div>
            <div class="drawer-item text-yellow-600 font-bold admin-only" onclick="switchView('review'); toggleMenu();"><i class="ph-bold ph-warning-circle"></i> Manager Review</div>
            <hr class="my-2">
            <div class="drawer-item text-red-600" onclick="location.reload()"><i class="ph-bold ph-sign-out"></i> Logout</div>
        </div>

        <div id="main-scroll-area" class="flex-grow overflow-y-auto p-4 pb-40 relative">
            
            <div id="view-home" class="hidden">
                <div class="bg-[#007a4d] text-white p-6 rounded-2xl mb-6 shadow-lg text-center">
                    <h1 class="text-2xl font-bold">GNC COMMAND</h1>
                    <p class="opacity-80 text-sm">Dashboard</p>
                </div>
                
                <h2 class="text-[11px] font-bold text-gray-400 uppercase tracking-wider mb-3 pl-1">App Modules</h2>
                <div class="grid grid-cols-2 gap-3 mb-8">
                    <div onclick="switchView('drive')" class="bg-white border border-gray-200 p-4 rounded-xl flex flex-col items-center justify-center gap-2 shadow-sm active:scale-95 transition-transform cursor-pointer">
                        <i class="ph-bold ph-car text-3xl text-blue-600"></i>
                        <span class="font-bold text-sm text-gray-800">Drive Mode</span>
                    </div>
                    <div onclick="switchView('tasks')" class="bg-white border border-gray-200 p-4 rounded-xl flex flex-col items-center justify-center gap-2 shadow-sm active:scale-95 transition-transform cursor-pointer">
                        <i class="ph-bold ph-clipboard-text text-3xl text-[#007a4d]"></i>
                        <span class="font-bold text-sm text-gray-800">Tasks</span>
                    </div>
                    <div onclick="switchView('docks')" class="bg-white border border-gray-200 p-4 rounded-xl flex flex-col items-center justify-center gap-2 shadow-sm active:scale-95 transition-transform cursor-pointer">
                        <i class="ph-bold ph-truck text-3xl text-orange-600"></i>
                        <span class="font-bold text-sm text-gray-800">Docks</span>
                    </div>
                    <div onclick="switchView('request')" class="bg-white border border-gray-200 p-4 rounded-xl flex flex-col items-center justify-center gap-2 shadow-sm active:scale-95 transition-transform cursor-pointer admin-only">
                        <i class="ph-bold ph-chat-circle-text text-3xl text-blue-600"></i>
                        <span class="font-bold text-sm text-gray-800">Requests</span>
                    </div>
                    <div onclick="switchView('sales-office')" class="bg-white border border-gray-200 p-4 rounded-xl flex flex-col items-center justify-center gap-2 shadow-sm active:scale-95 transition-transform cursor-pointer admin-only">
                        <i class="ph-bold ph-briefcase text-3xl text-purple-600"></i>
                        <span class="font-bold text-sm text-gray-800">Sales Office</span>
                    </div>
                    <div onclick="switchView('low-stock')" class="bg-white border border-gray-200 p-4 rounded-xl flex flex-col items-center justify-center gap-2 shadow-sm active:scale-95 transition-transform cursor-pointer dylan-only hidden">
                        <i class="ph-bold ph-trend-down text-3xl text-red-600"></i>
                        <span class="font-bold text-sm text-gray-800">Low Stock</span>
                    </div>
                    <div onclick="switchView('review')" class="bg-white border border-gray-200 p-4 rounded-xl flex flex-col items-center justify-center gap-2 shadow-sm active:scale-95 transition-transform col-span-2 cursor-pointer admin-only">
                        <i class="ph-bold ph-warning-circle text-3xl text-yellow-600"></i>
                        <span class="font-bold text-sm text-gray-800">Manager Review</span>
                    </div>
                </div>

                <div class="dylan-only hidden mb-8">
                    <h2 class="text-[11px] font-bold text-gray-400 uppercase tracking-wider mb-3 pl-1">Connected Databases</h2>
                    <div class="space-y-3">
                        <a href="https://docs.google.com/spreadsheets/d/13mdG9D4W3xmi6oKPeSY9-Xe38MJ_9GxYITll5PfQbMQ/edit" target="_blank" class="flex items-center gap-3 bg-white p-3 rounded-xl border border-gray-200 shadow-sm hover:bg-green-50 transition-colors">
                            <div class="bg-green-100 p-2 rounded-lg"><i class="ph-fill ph-database text-green-600 text-2xl"></i></div>
                            <div class="flex-grow min-w-0">
                                <div class="text-sm font-bold text-gray-800 truncate">Master Database</div>
                                <div class="text-[10px] text-gray-400 font-bold uppercase">DriveAround_Master_Data</div>
                            </div>
                            <i class="ph-bold ph-arrow-square-out text-gray-300"></i>
                        </a>
                        
                        <a href="https://docs.google.com/spreadsheets/d/1g7Dy2mDDljTs3e9FhQhdDQ-b7sw_gU1vCdcA14N4mKk/edit" target="_blank" class="flex items-center gap-3 bg-white p-3 rounded-xl border border-gray-200 shadow-sm hover:bg-blue-50 transition-colors">
                            <div class="bg-blue-100 p-2 rounded-lg"><i class="ph-fill ph-book-open-text text-blue-600 text-2xl"></i></div>
                            <div class="flex-grow min-w-0">
                                <div class="text-sm font-bold text-gray-800 truncate">Sales Notes Dictionary</div>
                                <div class="text-[10px] text-gray-400 font-bold uppercase">S1_SalesNotes</div>
                            </div>
                            <i class="ph-bold ph-arrow-square-out text-gray-300"></i>
                        </a>
                    </div>
                </div>
            </div>

            <div id="view-request" class="hidden admin-only">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-blue-600 uppercase">Requests</h2>
                    <span id="request-crumb" class="text-xs font-bold text-[#007a4d]"></span>
                </div>
                <div id="request-content"></div>
            </div>

            <div id="view-docks" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-orange-600 uppercase">Dock Loading</h2>
                    <span class="text-xs font-bold text-gray-400" id="docks-crumb">Select a Dock</span>
                </div>
                <input type="text" id="docks-search" class="input-field mb-2" placeholder="Search Plants..." onkeyup="handleDocksSearch()">
                <div id="docks-content"></div>
            </div>

            <div id="view-low-stock" class="hidden dylan-only">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-red-600 uppercase">Low Stock Alerts</h2>
                    <span class="text-xs font-bold text-gray-400" id="low-stock-crumb">Action Required</span>
                </div>
                <div id="low-stock-content"></div>
            </div>

            <div id="view-sales-office" class="hidden admin-only">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-purple-600 uppercase">Sales Office</h2>
                    <span class="text-xs font-bold text-gray-400">Completed Season Items</span>
                </div>
                <div id="sales-office-content"></div>
            </div>

            <div id="view-drive" class="hidden">
                <h2 class="text-sm font-bold text-blue-600 uppercase mb-4">Drive Mode</h2>
                <input type="text" id="drive-search" class="input-field mb-2" placeholder="Search Names or Locs..." onkeyup="handleDriveSearch()">
                <div id="drive-crumb" class="text-xs font-bold text-[#007a4d] mb-2"></div>
                <div id="drive-content"></div>
            </div>

            <div id="view-tasks" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-gray-400 uppercase">My Tasks</h2>
                    <span id="task-crumb" class="text-xs font-bold text-[#007a4d]"></span>
                </div>
                
                <div id="team-selector" class="hidden mb-4 grid grid-cols-1 gap-3"></div>
                
                <div id="task-tabs-container" class="task-tabs">
                    <div id="tab-season" class="task-tab active" onclick="setTaskTab('season')">Season Sales Notes</div>
                    <div id="tab-location" class="task-tab" onclick="setTaskTab('location')">Location Sales Notes</div>
                </div>
                <div id="task-content"></div>
            </div>
            
            <div id="view-review" class="hidden admin-only">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-yellow-600 uppercase">Manager Review</h2>
                    <span id="review-crumb" class="text-xs font-bold text-[#007a4d]"></span>
                </div>
                
                <div class="task-tabs mb-4">
                    <div id="review-tab-completed" class="task-tab active" onclick="setReviewTab('completed')">Completed Tasks</div>
                    <div id="review-tab-reserves" class="task-tab" onclick="setReviewTab('reserves')">Reserves</div>
                </div>

                <input type="text" id="reserves-search" class="input-field mb-2 hidden" placeholder="Search Plants or Customers..." onkeyup="handleReservesSearch()">

                <div id="review-content"></div>
            </div>
            
            <div id="view-detail" class="hidden">
                <div class="back-btn" onclick="goBackFromDetail()"><i class="ph-bold ph-arrow-left"></i> Back</div>
                <h1 id="det-common" class="text-2xl font-bold text-[#007a4d]">--</h1>
                <p id="det-size" class="text-gray-500 font-bold mb-4">--</p>
                
                <div class="detail-tabs">
                    <div class="detail-tab active" onclick="switchDetailTab('overview')" id="dtab-overview">Overview</div>
                    <div class="detail-tab" onclick="switchDetailTab('actions')" id="dtab-actions">Notes & Actions</div>
                    <div class="detail-tab" onclick="switchDetailTab('request')" id="dtab-request">Request Data</div>
                </div>
                
                <div id="det-overview-content" class="py-4">
                    <div class="overview-grid">
                        <div class="overview-card"><div class="overview-label">Location</div><div id="ov-loc" class="overview-val">--</div></div>
                        <div class="overview-card"><div class="overview-label">Qty Avail</div><div id="ov-avail" class="overview-val">--</div></div>
                        <div class="overview-card"><div class="overview-label">Item Code</div><div id="ov-item" class="overview-val">--</div></div>
                        <div class="overview-card"><div class="overview-label">Lot</div><div id="ov-lot" class="overview-val">--</div></div>
                        <div class="overview-card"><div class="overview-label">Quality Code</div><div id="ov-qual" class="overview-val">--</div></div>
                        <div class="overview-card"><div class="overview-label">Priority</div><div id="ov-prior" class="overview-val">--</div></div>
                        <div class="overview-card"><div class="overview-label">Tag Color</div><div id="ov-tag" class="overview-val">--</div></div>
                        <div class="overview-card"><div class="overview-label">Season Supply</div><div id="ov-season" class="overview-val">--</div></div>
                    </div>

                    <div id="expand-section" class="mt-6">
                        <div class="expand-trigger" onclick="toggleExpand()">
                            <span>View All Excel Columns</span><i class="ph-bold ph-caret-down"></i>
                        </div>
                        <div id="expand-content" class="expand-content"></div>
                    </div>
                </div>
                
                <div id="det-actions-content" class="hidden py-4">
                    <div id="photo-preview" class="mb-4 hidden">
                        <p class="text-[10px] font-bold text-blue-600 mb-2 uppercase">Photos on file</p>
                        <div id="photo-list-container" class="space-y-2"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <label class="bg-green-50 border-2 border-dashed border-green-500 text-green-700 flex flex-col items-center justify-center p-4 rounded-lg cursor-pointer">
                            <i class="ph-fill ph-camera text-3xl mb-1"></i>
                            <span class="text-[10px] font-bold">CAMERA</span>
                            <input type="file" accept="image/*" capture="environment" class="hidden" onchange="handlePhotoUpload(this)">
                        </label>
                        <label class="bg-blue-50 border-2 border-dashed border-blue-500 text-blue-700 flex flex-col items-center justify-center p-4 rounded-lg cursor-pointer">
                            <i class="ph-fill ph-image text-3xl mb-1"></i>
                            <span class="text-[10px] font-bold">LIBRARY</span>
                            <input type="file" accept="image/*" class="hidden" onchange="handlePhotoUpload(this)">
                        </label>
                    </div>

                    <div id="input-container">
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Match %</label>
                            <input type="number" id="in-match" class="input-field" placeholder="e.g. 95">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Spec (Size/Dims)</label>
                            <input type="text" id="in-spec" class="input-field" placeholder="e.g. 24-30 inch">
                        </div>
                        <div id="container-caliper" class="hidden">
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Caliper</label>
                            <input type="text" id="in-caliper" class="input-field" placeholder="e.g. 2 inch">
                        </div>
                        
                        <div id="quick-note-container" class="hidden mb-2">
                            <label class="text-[10px] font-bold text-green-700 uppercase">Quick Notes</label>
                            <select id="quick-note-select" class="input-field border-green-500 bg-green-50 text-sm font-bold text-green-800" onchange="applyQuickNote(this.value, 'in-sales-desc')">
                                <option value="">-- Select a Quick Note --</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="text-[10px] font-bold text-green-700 uppercase">Sales Description</label>
                            <input type="text" id="in-sales-desc" class="input-field border-green-500 bg-green-50 uppercase" oninput="this.value = this.value.toUpperCase()" placeholder="TYPE NOTES HERE...">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Pick Note</label>
                            <input type="text" id="in-pick" class="input-field" placeholder="e.g. Needs spacing">
                        </div>
                    </div>

                    <div class="flex gap-2 mt-4">
                        <button id="btn-save-draft" class="w-1/3 bg-gray-200 text-gray-700 font-bold py-4 rounded-xl shadow-md" onclick="saveData(false)">SAVE DRAFT</button>
                        <button id="btn-save-complete" class="w-2/3 bg-[#007a4d] text-white font-bold py-4 rounded-xl shadow-lg" onclick="saveData(true)">MARK COMPLETE</button>
                    </div>
                </div>

                <div id="det-request-content" class="hidden py-4">
                    <div id="req-photo-preview" class="mb-4 hidden">
                        <p class="text-[10px] font-bold text-purple-600 mb-2 uppercase">Request Photos</p>
                        <div id="req-photo-list-container" class="space-y-2"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <label class="bg-purple-50 border-2 border-dashed border-purple-500 text-purple-700 flex flex-col items-center justify-center p-4 rounded-lg cursor-pointer">
                            <i class="ph-fill ph-camera text-3xl mb-1"></i>
                            <span class="text-[10px] font-bold">CAMERA</span>
                            <input type="file" accept="image/*" capture="environment" class="hidden" onchange="handlePhotoUpload(this)">
                        </label>
                        <label class="bg-blue-50 border-2 border-dashed border-blue-500 text-blue-700 flex flex-col items-center justify-center p-4 rounded-lg cursor-pointer">
                            <i class="ph-fill ph-image text-3xl mb-1"></i>
                            <span class="text-[10px] font-bold">LIBRARY</span>
                            <input type="file" accept="image/*" class="hidden" onchange="handlePhotoUpload(this)">
                        </label>
                    </div>

                    <div id="req-input-container">
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Match %</label>
                            <input type="number" id="req-match" class="input-field" placeholder="e.g. 95">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Spec (Size/Dims)</label>
                            <input type="text" id="req-spec" class="input-field" placeholder="e.g. 24-30 inch">
                        </div>
                        <div id="req-container-caliper" class="hidden">
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Caliper</label>
                            <input type="text" id="req-caliper" class="input-field" placeholder="e.g. 2 inch">
                        </div>

                        <div id="req-quick-note-container" class="hidden mb-2">
                            <label class="text-[10px] font-bold text-purple-700 uppercase">Quick Notes</label>
                            <select id="req-quick-note-select" class="input-field border-purple-500 bg-purple-50 text-sm font-bold text-purple-800" onchange="applyQuickNote(this.value, 'req-sales-desc')">
                                <option value="">-- Select a Quick Note --</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-purple-700 uppercase">Sales Description</label>
                            <input type="text" id="req-sales-desc" class="input-field border-purple-500 bg-purple-50 uppercase" oninput="this.value = this.value.toUpperCase()" placeholder="TYPE NOTES HERE...">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Pick Note</label>
                            <input type="text" id="req-pick" class="input-field" placeholder="e.g. Needs spacing">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Comments</label>
                            <input type="text" id="req-comments" class="input-field" placeholder="Any additional comments...">
                        </div>
                    </div>

                    <div class="flex gap-2 mt-4">
                        <button id="req-btn-save-draft" class="w-full bg-purple-600 text-white font-bold py-4 rounded-xl shadow-lg" onclick="saveData(false)">SAVE REQUEST DATA</button>
                    </div>
                </div>

            </div>

        </div>

        <div id="global-action-bar" class="hidden fixed bottom-[60px] left-0 w-full bg-white p-3 shadow-[0_-10px_15px_-3px_rgba(0,0,0,0.15)] z-[45] border-t border-gray-200">
            <div class="flex justify-between items-center mb-2 px-1">
                <span class="text-xs font-bold text-[#007a4d]"><span id="sel-count">0</span> Items Selected</span>
                <span class="text-[10px] font-bold text-red-500 cursor-pointer bg-red-50 px-3 py-1 rounded-md uppercase" onclick="clearSelection()">Clear Selection</span>
            </div>
            <div class="flex gap-1">
                <button onclick="initiateBatchAction('copy')" class="flex-1 bg-gray-100 text-gray-700 p-2 rounded-lg text-[10px] font-bold hover:bg-gray-200"><i class="ph-bold ph-copy block text-lg mb-1"></i> Copy</button>
                <button onclick="initiateBatchAction('email')" class="flex-1 bg-blue-100 text-blue-700 p-2 rounded-lg text-[10px] font-bold hover:bg-blue-200"><i class="ph-bold ph-envelope block text-lg mb-1"></i> Email</button>
                <button onclick="initiateBatchAction('text')" class="flex-1 bg-green-100 text-green-700 p-2 rounded-lg text-[10px] font-bold hover:bg-green-200"><i class="ph-bold ph-chat block text-lg mb-1"></i> Text</button>
                <button onclick="initiateBatchAction('assign')" class="flex-1 bg-purple-100 text-purple-700 p-2 rounded-lg text-[10px] font-bold hover:bg-purple-200"><i class="ph-bold ph-user-plus block text-lg mb-1"></i> Assign</button>
                <button onclick="initiateBatchAction('request_action')" class="flex-1 bg-orange-500 text-white p-2 rounded-lg text-[10px] font-bold shadow-md"><i class="ph-bold ph-warning-circle block text-lg mb-1"></i> Request</button>
            </div>
        </div>

        <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around py-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50">
            <div onclick="switchView('home')"><i class="ph-bold ph-house text-2xl text-gray-400"></i></div>
            <div onclick="switchView('drive')"><i class="ph-bold ph-car text-2xl text-gray-400"></i></div>
            <div onclick="switchView('tasks')"><i class="ph-bold ph-clipboard-text text-2xl text-gray-400"></i></div>
            <div onclick="switchView('docks')"><i class="ph-bold ph-truck text-2xl text-gray-400"></i></div>
        </nav>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzhJ_tytv5Rm2ag44liZAU6nsp0lQ7-9PLmjxrcuT1WA1WARubi7NyolYoTZ_qvZmzo/exec";

        let appUsers = [];
        let fullInventory = []; 
        let lowStockInventory = []; 
        let socInventory = []; 
        let reservesInventory = []; 
        let salesNotesDict = {}; 
        
        let currentUser = "";
        let currentRole = "";
        
        let activeItem = null;
        let lastView = "";
        let activeDetailTab = "overview";

        let selectedItems = new Set();
        let isMultiSelectMode = false;
        let pressTimer = null;
        let isLongPress = false;
        let touchStartX = 0;
        let touchStartY = 0;

        let pendingAction = null;
        let pendingTabType = null;

        let driveViewLevel = 0;
        let selectedDriveName = null;
        let selectedDriveSize = null;

        let activeTaskTab = "season";
        let taskViewTargetUser = null; 
        let taskViewLevel = 0; 
        let selectedTaskBlock = null;
        let selectedTaskLoc = null;

        let lowStockViewLevel = 0;
        let selectedLowStockName = null;
        let selectedLowStockSize = null;

        let reviewViewLevel = 0;
        let selectedReviewUser = null;
        let activeReviewTab = "completed"; 

        let requestViewLevel = 0;
        let requestFilterMode = null;
        let selectedReqRep = null;
        let selectedReqRepStatus = null; 
        
        let dockViewLevel = 0;
        let selectedDockNum = null;
        let selectedDockName = null;
        let selectedDockSize = null;
        let selectedDockItemCode = null;

        let reservesViewLevel = 0;
        let selectedReservesName = null;
        let selectedReservesSize = null;

        function getDirectImageUrl(url) {
            if (!url) return "";
            let match = url.match(/id=([a-zA-Z0-9_-]+)/);
            if (!match) match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (match && match[1]) {
                return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w100`;
            }
            return url;
        }

        window.onload = function() {};

        function handleLogin(isBiometricLogin = false) {
            const inputUser = document.getElementById('username-input').value.trim().toLowerCase();
            const inputPass = document.getElementById('pin-code').value.trim();

            if (!inputUser || !inputPass) {
                showToast("Error", "Please enter username and password", true);
                return;
            }

            document.getElementById('login-inputs').classList.add('hidden');
            document.getElementById('loading-spinner').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "Authenticating & Syncing...";

            const loginUrl = `${GOOGLE_SCRIPT_URL}?action=login&username=${encodeURIComponent(inputUser)}&password=${encodeURIComponent(inputPass)}`;

            fetch(loginUrl)
                .then(response => response.json())
                .then(res => {
                    if (res.status === 'success') {
                        currentUser = inputUser;
                        currentRole = res.role;
                        document.getElementById('header-user').innerText = currentUser.toUpperCase();

                        salesNotesDict = res.salesNotesMap || {};

                        fullInventory = res.data.map((item, idx) => {
                            item.DOM_ID = 'fi_' + idx;
                            return item;
                        });

                        // --- START TOURNAMENT DEDUPLICATION ---
                        let itemsWithPriority = {};
                        fullInventory.forEach(item => {
                            const pri = parseFloat(item.PRIORITY);
                            const ptr = parseFloat(item.PTRAVAILABLE) || 0;
                            const ss = parseFloat(item.SEASONSUPPLY) || 0;
                            const iCode = String(item.ITEMCODE || "").trim().toUpperCase();

                            if (iCode && !isNaN(pri) && pri > 0 && ptr >= (ss * 1.10)) {
                                if (!itemsWithPriority[iCode]) itemsWithPriority[iCode] = [];
                                itemsWithPriority[iCode].push(item);
                            }
                        });

                        let seasonWinnerIds = new Set();
                        for (const code in itemsWithPriority) {
                            let group = itemsWithPriority[code];
                            
                            group.sort((a, b) => {
                                const priA = parseFloat(a.PRIORITY);
                                const priB = parseFloat(b.PRIORITY);
                                if (priA === priB) {
                                    return (parseFloat(b.PTRAVAILABLE) || 0) - (parseFloat(a.PTRAVAILABLE) || 0);
                                }
                                return priA - priB;
                            });
                            
                            seasonWinnerIds.add(group[0].DOM_ID);
                        }

                        fullInventory.forEach(item => {
                            item.APP_TAB_ASSIGNMENT = seasonWinnerIds.has(item.DOM_ID) ? 'season' : 'location';
                        });
                        // --- END TOURNAMENT DEDUPLICATION ---

                        lowStockInventory = (res.lowStock || []).map((item, idx) => {
                            item.DOM_ID = 'ls_' + idx;
                            return item;
                        });
                        
                        socInventory = res.socData || [];
                        
                        reservesInventory = (res.reservesData || []).map((item, idx) => {
                            item.DOM_ID = 'res_' + idx;
                            item.UNIQUE_ID = item.UNIQUE_ID || 'res_uid_' + idx; 
                            item.COMMONNAME = item.COMMONNAME || item['PLANT NAME'] || item.DESCRIPTION || item.DESC || 'Unknown Plant';
                            item.CONTSIZE = item.CONTSIZE || item.SIZE || item.CONTAINER || '-';
                            item.CUSTOMERNAME = item.CUSTOMERNAME || item.CUSTOMER || 'Unknown Customer';
                            item.CONSIGNEENAME = item.CONSIGNEENAME || item.CONSIGNEE || '';
                            item.SALESREPNAME = item.SALESREPNAME || item.SALESREP || item['SALES REP'] || 'Unknown Rep';
                            return item;
                        });
                        
                        if (!isBiometricLogin && window.PublicKeyCredential) {
                            promptToEnableBiometrics(inputUser, inputPass);
                        }

                        applyRolePermissions();
                    } else {
                        alert("MISMATCH DETECTED!\n\nIncorrect Username or Password.");
                        document.getElementById('pin-code').value = "";
                        document.getElementById('login-inputs').classList.remove('hidden');
                        document.getElementById('loading-spinner').classList.add('hidden');
                    }
                })
                .catch(err => {
                    showToast("Error", "Network Error. Please try again.", true);
                    document.getElementById('login-inputs').classList.remove('hidden');
                    document.getElementById('loading-spinner').classList.add('hidden');
                });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if (window.PublicKeyCredential && localStorage.getItem('gnc_user_v3') && localStorage.getItem('gnc_pin_v3')) {
                document.getElementById('btn-fingerprint').classList.remove('hidden');
            }
        });

        async function promptToEnableBiometrics(user, pass) {
            if (localStorage.getItem('gnc_user_v3') === user) return;

            if (confirm("Would you like to enable Fingerprint/FaceID login for next time?")) {
                try {
                    const challenge = new Uint8Array(32);
                    window.crypto.getRandomValues(challenge);
                    const userId = new Uint8Array(16);
                    window.crypto.getRandomValues(userId);

                    await navigator.credentials.create({
                        publicKey: {
                            challenge: challenge,
                            rp: { name: "GNC SALES COMMAND", id: window.location.hostname },
                            user: { id: userId, name: user, displayName: user.toUpperCase() },
                            pubKeyCredParams: [{type: "public-key", alg: -7}, {type: "public-key", alg: -257}],
                            authenticatorSelection: { 
                                authenticatorAttachment: "platform", 
                                residentKey: "required", 
                                requireResidentKey: true, 
                                userVerification: "required" 
                            },
                            timeout: 60000
                        }
                    });

                    localStorage.setItem('gnc_user_v3', user);
                    localStorage.setItem('gnc_pin_v3', pass);
                    document.getElementById('btn-fingerprint').classList.remove('hidden');
                    showToast("Success", "Passkey enabled!");
                    
                } catch(e) {
                    console.error(e);
                    showToast("Notice", "Passkey setup canceled or unsupported.", true);
                }
            }
        }

        async function loginWithBiometric() {
            try {
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);

                const credential = await navigator.credentials.get({
                    publicKey: {
                        challenge: challenge,
                        timeout: 60000,
                        userVerification: "required" 
                    }
                });

                if (credential) {
                    document.getElementById('username-input').value = localStorage.getItem('gnc_user_v3');
                    document.getElementById('pin-code').value = localStorage.getItem('gnc_pin_v3');
                    handleLogin(true); 
                }
            } catch (err) {
                console.error(err);
                showToast("Biometric Error", "Fingerprint failed or was canceled.", true);
            }
        }

        function applyRolePermissions() {
            document.getElementById('view-login').style.display = 'none';
            document.getElementById('app-wrapper').classList.remove('hidden');
            const isAdmin = (currentRole === 'Admin');
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'block' : 'none');
            
            const isDylan = (currentUser === 'dylan_collyge' || currentUser === 'dylan');
            document.querySelectorAll('.dylan-only').forEach(el => {
                el.style.display = isDylan ? 'block' : 'none';
                el.classList.remove('hidden'); 
            });

            switchView('home');
        }

        function toggleMenu() {
            document.getElementById('side-drawer').classList.toggle('open');
            document.getElementById('drawer-overlay').classList.toggle('open');
        }

        function showToast(title, message, isAlert = false) {
            const toast = document.getElementById('toast-notification');
            toast.style.background = isAlert ? '#ef4444' : '#16a34a';
            toast.innerHTML = `<div class="font-bold text-sm">${title}</div><div class="text-xs">${message}</div>`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function switchView(viewId) {
            ['view-home','view-drive','view-tasks','view-review','view-sales-office','view-low-stock','view-detail','view-docks','view-request'].forEach(id => { 
                document.getElementById(id).classList.add('hidden'); 
            });
            document.getElementById('view-' + viewId).classList.remove('hidden');
            
            if(viewId === 'drive') {
                document.getElementById('drive-search').value = "";
                resetDriveView(); 
            }
            if(viewId === 'tasks') {
                if (currentRole === 'Admin' && !taskViewTargetUser) renderTeamSelector();
                else renderTasks();
            }
            if(viewId === 'review') { 
                reviewViewLevel = 0; 
                setReviewTab('completed'); 
            }
            if(viewId === 'request') {
                requestViewLevel = 0;
                renderRequest();
            }
            if(viewId === 'sales-office') { renderSalesOffice(); }
            if(viewId === 'low-stock') { resetLowStockView(); }
            if(viewId === 'docks') { 
                document.getElementById('docks-search').value = "";
                resetDockView(); 
            }
        }

        function reRenderCurrentView() {
            if(!document.getElementById('view-drive').classList.contains('hidden')) renderDrive();
            if(!document.getElementById('view-tasks').classList.contains('hidden')) renderTasks();
            if(!document.getElementById('view-sales-office').classList.contains('hidden')) renderSalesOffice();
            if(!document.getElementById('view-low-stock').classList.contains('hidden')) renderLowStock();
            if(!document.getElementById('view-docks').classList.contains('hidden')) renderDocks();
            if(!document.getElementById('view-review').classList.contains('hidden')) renderReview();
            if(!document.getElementById('view-request').classList.contains('hidden')) renderRequest();
        }

        function setTaskTab(tab) {
            activeTaskTab = tab;
            document.getElementById('tab-season').classList.toggle('active', tab === 'season');
            document.getElementById('tab-location').classList.toggle('active', tab === 'location');
            taskViewLevel = 0; 
            renderTasks();
        }

        function setReviewTab(tab) {
            activeReviewTab = tab;
            document.getElementById('review-tab-completed').classList.toggle('active', tab === 'completed');
            document.getElementById('review-tab-reserves').classList.toggle('active', tab === 'reserves');
            reviewViewLevel = 0; 
            reservesViewLevel = 0;
            renderReview();
        }

        function selectRequestCategory(cat) {
            requestFilterMode = cat;
            requestViewLevel = 1;
            renderRequest();
        }

        function selectRequestRep(rep) {
            selectedReqRep = rep;
            requestViewLevel = 2;
            renderRequest();
        }

        function selectRepStatus(status) {
            selectedReqRepStatus = status;
            requestViewLevel = 3;
            renderRequest();
        }
        
        function handleReservesSearch() {
            const term = document.getElementById('reserves-search').value;
            if (term.length > 0 && reservesViewLevel > 0) { 
                reservesViewLevel = 0; 
                selectedReservesName = null; 
                selectedReservesSize = null; 
            }
            renderReview();
        }

        function selectReservesName(name) { selectedReservesName = name; reservesViewLevel = 1; renderReview(); }
        function selectReservesSize(size) { selectedReservesSize = size; reservesViewLevel = 2; renderReview(); }

        function getLocPrefix(loc) {
            if(!loc) return "Unassigned";
            const match = loc.match(/^[A-Za-z]+/);
            return match ? match[0] : loc.substring(0,2);
        }

        function startPress(e, domId) {
            if (isMultiSelectMode) return;
            isLongPress = false;
            if(e.type === 'touchstart') {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }
            pressTimer = setTimeout(() => {
                isLongPress = true;
                if (navigator.vibrate) navigator.vibrate(50); 
                enableMultiSelect(domId);
            }, 2000);
        }

        function checkMove(e) {
            if(e.type === 'touchmove') {
                let dx = Math.abs(e.touches[0].clientX - touchStartX);
                let dy = Math.abs(e.touches[0].clientY - touchStartY);
                if (dx > 10 || dy > 10) cancelPress(); 
            }
        }

        function cancelPress() {
            clearTimeout(pressTimer);
        }

        function enableMultiSelect(firstDomId) {
            isMultiSelectMode = true;
            document.body.classList.add('multi-select-mode');
            selectedItems.add(firstDomId);
            updateGlobalActionBar();
            
            const rows = document.querySelectorAll('.item-row');
            rows.forEach(row => {
                const domId = row.getAttribute('data-dom-id');
                const cb = row.querySelector('.card-checkbox');
                if(cb) cb.checked = selectedItems.has(domId);
            });
        }

        function clearSelection() {
            isMultiSelectMode = false;
            document.body.classList.remove('multi-select-mode');
            selectedItems.clear();
            updateGlobalActionBar();
            
            document.querySelectorAll('.card-checkbox').forEach(cb => {
                cb.checked = false;
            });
        }

        function toggleGlobalItem(domId, isChecked) {
            if (isChecked) selectedItems.add(domId);
            else selectedItems.delete(domId);
            updateGlobalActionBar();
        }

        function handleCardClick(domId, uniqueId, sourceView) {
            if (isLongPress) {
                isLongPress = false; 
                return;
            }
            
            if (isMultiSelectMode) {
                const row = document.querySelector(`[data-dom-id="${domId}"]`);
                if(row) {
                    const cb = row.querySelector('.card-checkbox');
                    if(cb) {
                        cb.checked = !cb.checked;
                        toggleGlobalItem(domId, cb.checked);
                    }
                }
            } else {
                openDetail(uniqueId, sourceView);
            }
        }

        function updateGlobalActionBar() {
            const bar = document.getElementById('global-action-bar');
            if (selectedItems.size > 0) {
                bar.classList.remove('hidden');
                document.getElementById('sel-count').innerText = selectedItems.size;
            } else {
                bar.classList.add('hidden');
            }
        }

        function generateCard(item, sourceView, colorClass = 'status-green') {
            let thumbHtml = '';
            let photoLink = item.SAVED_PHOTO_LINK || item['PHOTO LINK'] || item.PHOTOLINK || "";
            
            if (photoLink) {
                let firstUrl = photoLink.split(',')[0];
                let cleanUrl = firstUrl.trim();
                let urlMatch = firstUrl.match(/(https?:\/\/[^"\s>]+)/);
                if (urlMatch) cleanUrl = urlMatch[1];

                let thumbUrl = getDirectImageUrl(cleanUrl);
                if (thumbUrl.startsWith('http')) {
                    thumbHtml = `<div class="ml-3 flex-shrink-0"><img src="${thumbUrl}" class="w-12 h-12 rounded-md object-cover border border-gray-200" loading="lazy"></div>`;
                }
            }

            const isChecked = selectedItems.has(item.DOM_ID) ? 'checked' : '';
            const tagColor = item.FIELDTAGCOLOR || item['FIELD TAG COLOR'] || '-';

            return `
            <div class="flex items-center w-full mb-2 item-row" data-dom-id="${item.DOM_ID}"
                 onmousedown="startPress(event, '${item.DOM_ID}')" 
                 onmouseup="cancelPress()" 
                 onmouseleave="cancelPress()" 
                 ontouchstart="startPress(event, '${item.DOM_ID}')" 
                 ontouchend="cancelPress()" 
                 ontouchcancel="cancelPress()"
                 ontouchmove="checkMove(event)"
                 onclick="handleCardClick('${item.DOM_ID}', '${item.UNIQUE_ID}', '${sourceView}')">
                
                <div class="card-checkbox-container flex-shrink-0">
                    <input type="checkbox" class="card-checkbox w-6 h-6 rounded border-gray-300 text-[#007a4d] focus:ring-[#007a4d] shadow-sm pointer-events-none" ${isChecked}>
                </div>
                
                <div class="inv-card ${colorClass} flex items-center justify-between flex-grow !mb-0 transition-transform active:scale-[0.99]">
                    <div class="flex-grow min-w-0">
                        <div class="flex justify-between font-bold text-sm mb-1">
                            <span class="text-[#007a4d] truncate pr-2">${item.LOCATIONCODE || 'No Loc'}  ${item.COMMONNAME || 'Unknown'}</span>
                            <span class="whitespace-nowrap bg-gray-100 text-gray-800 px-1.5 py-0.5 rounded text-xs border border-gray-200">${item.CONTSIZE || '-'}</span>
                        </div>
                        <div class="text-[11px] text-gray-500 truncate mt-0.5">
                            <span class="font-bold text-blue-600">Pri: ${item.PRIORITY || '-'}</span> | 
                            <span class="font-bold text-gray-800">QC: ${item.QUALITYCODE || '-'}</span> | 
                            <span class="font-bold text-purple-600">Tag: ${tagColor}</span>
                        </div>
                        <div class="text-[11px] text-gray-500 truncate mt-0.5">
                            <span class="font-bold text-[#007a4d]">Qty: ${item.PTRAVAILABLE || '0'}</span> | 
                            <span class="font-bold text-orange-600">Lot: ${item.LOTCODE || '-'}</span> | 
                            Supply: ${item.SEASONSUPPLY || '0'}
                        </div>
                    </div>
                    ${thumbHtml}
                </div>
            </div>`;
        }
        
        function initiateBatchAction(action) {
            if (action === 'request_action') {
                document.getElementById('request-rep-modal').classList.remove('hidden');
                return;
            }
            pendingAction = action;
            document.getElementById('tab-select-modal').classList.remove('hidden');
        }

        function confirmRequestAction(repName) {
            document.getElementById('request-rep-modal').classList.add('hidden');
            const domIds = Array.from(selectedItems);
            const uniqueIds = [];
            
            domIds.forEach(dId => {
                let item = fullInventory.find(i => i.DOM_ID === dId) || lowStockInventory.find(i => i.DOM_ID === dId);
                if (item) {
                    item.IS_REQUEST = true; 
                    item.REQUESTED_BY = repName; 
                    uniqueIds.push(item.UNIQUE_ID);
                }
            });

            showToast("Processing...", `Saving request for ${repName}...`, false);

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ type: 'batch_request', ids: uniqueIds, repName: repName })
            }).then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast("Success", "Items moved to Request tab!");
                    clearSelection();
                    switchView('request');
                } else { showToast("Error", "Failed to update sheet.", true); }
            }).catch(err => showToast("Error", "Network error.", true));
        }

        function processTabSelection(tab) {
            pendingTabType = tab;
            document.getElementById('tab-select-modal').classList.add('hidden');
            
            if (pendingAction === 'assign') {
                openAssignModal();
            } else {
                executeBatchAction(pendingAction, pendingTabType);
            }
        }

        function getSelectedItemsText(tabType) {
            let items = [];
            selectedItems.forEach(domId => {
                let found = fullInventory.find(i => i.DOM_ID === domId) || lowStockInventory.find(i => i.DOM_ID === domId);
                if (found) items.push(found);
            });

            let headerTitle = tabType === 'request' ? "REQUEST DATA" : "SALES NOTES";
            let returnText = `${headerTitle}\n\n`;

            items.forEach(i => {
                returnText += ` ${i.COMMONNAME || 'Unknown'} (${i.CONTSIZE || '-'}) | Loc: ${i.LOCATIONCODE || 'No Loc'}\n`;
                
                let match = tabType === 'request' ? i.REQ_MATCH : (i.MATCH || i.MATCHPCT);
                if (match) returnText += `  Match: ${match}%\n`;
                
                let spec = tabType === 'request' ? i.REQ_SPEC : i.SPEC;
                if (spec) returnText += `  Spec: ${spec}\n`;
                
                let caliper = tabType === 'request' ? i.REQ_CALIPER : i.CALIPER;
                if (caliper) returnText += `  Caliper: ${caliper}\n`;
                
                let pick = tabType === 'request' ? i.REQ_PICK : (i.PIC_NOTE || i.PICKNOTE || i.PICK);
                if (pick) returnText += `  Pick Note: ${pick}\n`;
                
                let sales = tabType === 'request' ? i.REQ_SALES_NOTE : (i.SALES_NOTE || i.SALESNOTE || i.SALESDESC);
                if (sales) returnText += `  Sales Note: ${sales}\n`;

                if (tabType === 'request' && i.REQ_COMMENTS) returnText += `  Comments: ${i.REQ_COMMENTS}\n`;
                
                let photo = tabType === 'request' ? i.REQ_PHOTO_LINK : (i.SAVED_PHOTO_LINK || i['PHOTO LINK'] || i.PHOTOLINK);
                if (photo && photo.trim() !== "") {
                    let urls = photo.split(',');
                    let counter = 1;
                    urls.forEach(url => {
                        let cleanUrl = url.trim();
                        let match = cleanUrl.match(/(https?:\/\/[^"\s>]+)/);
                        if (match) {
                            returnText += `  Photo ${counter}: ${match[1]}\n`;
                            counter++;
                        }
                    });
                }
                returnText += `\n`;
            });

            return returnText;
        }

        function executeBatchAction(action, tabType) {
            const text = getSelectedItemsText(tabType);
            
            if (action === 'copy') {
                navigator.clipboard.writeText(text).then(() => {
                    showToast("Success", "Copied to clipboard!");
                    clearSelection();
                });
            } else if (action === 'email') {
                let sub = tabType === 'request' ? 'Request Data' : 'Sales Notes';
                window.location.href = `mailto:?subject=${sub}&body=${encodeURIComponent(text)}`;
                clearSelection();
            } else if (action === 'text') {
                window.location.href = `sms:?&body=${encodeURIComponent(text)}`;
                clearSelection();
            }
        }

        function openAssignModal() { document.getElementById('assign-modal').classList.remove('hidden'); }
        function closeAssignModal() { document.getElementById('assign-modal').classList.add('hidden'); }

        function confirmAssign(user) {
            closeAssignModal();
            showToast("Assigning...", "Updating Google Sheet...", false);
            
            const domIds = Array.from(selectedItems);
            const uniqueIds = [];
            let itemsToUpdate = [];
            
            domIds.forEach(dId => {
                let item = fullInventory.find(i => i.DOM_ID === dId) || lowStockInventory.find(i => i.DOM_ID === dId);
                if (item) {
                    uniqueIds.push(item.UNIQUE_ID);
                    itemsToUpdate.push(item);
                }
            });
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ type: 'batch_assign', ids: uniqueIds, assignTo: user, tabType: pendingTabType })
            }).then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast("Success", `Assigned to ${user} and email sent!`);
                    itemsToUpdate.forEach(item => {
                        item.ASSIGNEDTO = user;
                        item.DATE_COMPLETED = ""; 
                    });
                    clearSelection(); 
                } else { showToast("Error", "Assignment failed", true); }
            }).catch(err => showToast("Error", "Network error.", true));
        }

        function handleDocksSearch() {
            const term = document.getElementById('docks-search').value;
            if (term.length > 0 && dockViewLevel > 1) { 
                dockViewLevel = 1; 
                selectedDockName = null; 
                selectedDockSize = null; 
                selectedDockItemCode = null;
            }
            renderDocks();
        }

        function resetDockView() {
            dockViewLevel = 0;
            selectedDockNum = null;
            selectedDockName = null;
            selectedDockSize = null;
            selectedDockItemCode = null;
            document.getElementById('docks-search').value = "";
            renderDocks();
        }

        function selectDockNum(num) { selectedDockNum = num; dockViewLevel = 1; renderDocks(); }
        function selectDockPlant(itemCode, name, size) { 
            selectedDockItemCode = itemCode; 
            selectedDockName = name; 
            selectedDockSize = size; 
            dockViewLevel = 2; 
            renderDocks(); 
        }

        function renderDocks() {
            const container = document.getElementById('docks-content');
            const crumb = document.getElementById('docks-crumb');
            const term = document.getElementById('docks-search').value.toLowerCase();
            
            if (dockViewLevel === 0) {
                crumb.innerText = "Select a Dock";
                let activeDocks = new Set();
                
                socInventory.forEach(i => {
                    if (term) {
                        let searchStr = (i.COMMONNAME || i['PLANT NAME'] || i.CUSTOMERNAME || i.SALESREPNAME || 'Unknown').toLowerCase();
                        if (searchStr.includes(term) && i.DOCK_NUM) activeDocks.add(i.DOCK_NUM);
                    } else {
                        if (i.DOCK_NUM) activeDocks.add(i.DOCK_NUM);
                    }
                });

                let html = '<div class="grid grid-cols-4 gap-2">';
                let sortedDocks = Array.from(activeDocks).sort((a, b) => a - b);
                
                sortedDocks.forEach(i => {
                    html += `
                    <div class="bg-white border border-gray-200 p-3 rounded-xl shadow-sm text-center cursor-pointer hover:bg-gray-50 active:scale-95 transition-transform" onclick="selectDockNum(${i})">
                        <i class="ph-bold ph-truck text-2xl text-orange-500 mb-1"></i>
                        <div class="font-bold text-[10px] text-gray-700">DOCK ${i}</div>
                    </div>`;
                });
                html += '</div>';

                if (activeDocks.size === 0) {
                    container.innerHTML = `<div class="p-8 text-center text-gray-400">No docks ${term ? `contain items matching "${term}"` : 'have data currently'}.</div>`;
                } else { container.innerHTML = html; }
            } 
            
            else if (dockViewLevel === 1) {
                crumb.innerText = `Dock ${selectedDockNum} > Stops & Plants`;
                let dockItems = socInventory.filter(i => i.DOCK_NUM === selectedDockNum);
                
                if (term) {
                    dockItems = dockItems.filter(i => {
                        let searchStr = (i.COMMONNAME || i['PLANT NAME'] || i.CUSTOMERNAME || i.SALESREPNAME || 'Unknown').toLowerCase();
                        return searchStr.includes(term);
                    });
                }
                
                if (dockItems.length === 0) {
                    container.innerHTML = `<div class="back-btn" onclick="dockViewLevel=0; renderDocks()"><i class="ph-bold ph-arrow-left"></i> Back to Docks</div><div class="p-8 text-center text-gray-400">No matching stops found.</div>`;
                    return;
                }

                let stopsMap = {};
                dockItems.forEach(i => {
                    let stopNum = i.STOPNUMBER || "Unassigned"; 
                    if (!stopsMap[stopNum]) {
                        stopsMap[stopNum] = {
                            salesRep: i.SALESREPNAME || i.SALESREP || "Unknown Rep",
                            customer: i.CUSTOMERNAME || i.CUSTOMER || "Unknown Customer",
                            consignee: i.CONSIGNEENAME || i.CONSIGNEE || "",
                            plants: {} 
                        };
                    }
                    
                    let name = i.COMMONNAME || i['PLANT NAME'] || i.DESC || i.DESCRIPTION || 'Unknown';
                    let size = i.CONTSIZE || i.SIZE || i.CONTAINER || '-';
                    let itemCode = i.ITEMCODE || i.ITEM || 'No Item';
                    let key = `${itemCode}|${name}|${size}`;
                    
                    if (!stopsMap[stopNum].plants[key]) {
                        stopsMap[stopNum].plants[key] = { itemCode, name, size, count: 0 };
                    }
                    stopsMap[stopNum].plants[key].count++;
                });

                let html = `<div class="back-btn" onclick="dockViewLevel=0; document.getElementById('docks-search').value=''; renderDocks()"><i class="ph-bold ph-arrow-left"></i> Back to Docks</div>`;
                
                Object.keys(stopsMap).sort((a,b) => String(a).localeCompare(String(b), undefined, {numeric:true})).forEach(stop => {
                    let s = stopsMap[stop];
                    let custDisplay = s.customer;
                    if (s.consignee && s.consignee.trim() !== "" && s.consignee !== s.customer) {
                        custDisplay += ` - ${s.consignee}`;
                    }
                    
                    html += `
                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm mb-4 overflow-hidden">
                        <div class="bg-orange-50 p-3 border-b border-gray-200">
                            <div class="flex justify-between items-start mb-1">
                                <div class="font-bold text-lg text-orange-700">Stop ${stop}</div>
                                <div class="text-[10px] font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded uppercase"><i class="ph-bold ph-user mr-1"></i>${s.salesRep}</div>
                            </div>
                            <div class="text-sm font-bold text-gray-800 leading-tight">${custDisplay}</div>
                        </div>
                        <div class="flex flex-col">`;
                    
                    Object.values(s.plants).sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                        html += `
                            <div class="p-3 border-b border-gray-100 last:border-b-0 cursor-pointer hover:bg-gray-50 active:bg-gray-100 flex justify-between items-center" onclick="selectDockPlant('${p.itemCode.replace(/'/g, "\\'")}', '${p.name.replace(/'/g, "\\'")}', '${p.size}')">
                                <div class="flex-grow min-w-0 pr-3">
                                    <div class="font-bold text-sm text-[#007a4d] truncate">${p.name}</div>
                                    <div class="text-[11px] font-semibold text-gray-500 mt-1 flex items-center gap-2">
                                        <span class="bg-gray-100 border border-gray-200 px-1.5 py-0.5 rounded text-gray-700">${p.size}</span>
                                        <span class="text-blue-600"><i class="ph-bold ph-barcode mr-0.5"></i>${p.itemCode}</span>
                                    </div>
                                </div>
                                <i class="ph-bold ph-caret-right text-gray-300 text-lg"></i>
                            </div>`;
                    });
                    
                    html += `</div></div>`;
                });
                
                container.innerHTML = html;
            }
            
            else if (dockViewLevel === 2) {
                crumb.innerText = `Dock ${selectedDockNum} > ${selectedDockName} (${selectedDockSize})`;
                
                let targetCode = String(selectedDockItemCode || "").trim().toUpperCase();

                let finalItems = fullInventory.filter(i => {
                    let iCode = String(i.ITEMCODE || "").trim().toUpperCase();
                    if (targetCode && targetCode !== "NO ITEM") {
                        return iCode === targetCode;
                    } else {
                        return i.COMMONNAME === selectedDockName && i.CONTSIZE === selectedDockSize;
                    }
                });
                
                finalItems.sort((a,b) => (a.LOCATIONCODE||"").localeCompare((b.LOCATIONCODE||""), undefined, {numeric: true}));

                if (finalItems.length === 0) {
                     container.innerHTML = `<div class="back-btn" onclick="dockViewLevel=1; renderDocks()"><i class="ph-bold ph-arrow-left"></i> Back to Stop</div><div class="p-8 text-center text-gray-400">This plant was requested for the Dock, but no matching records exist in the Master Inventory.</div>`;
                     return;
                }
                
                container.innerHTML = `<div class="back-btn" onclick="dockViewLevel=1; renderDocks()"><i class="ph-bold ph-arrow-left"></i> Back to Stop</div>` + 
                finalItems.map(i => generateCard(i, 'docks', 'status-orange')).join('');
            }
        }

        function resetLowStockView() { 
            lowStockViewLevel = 0; 
            selectedLowStockName = null; 
            selectedLowStockSize = null; 
            renderLowStock(); 
        }
        function selectLowStockName(name) { selectedLowStockName = name; lowStockViewLevel = 1; renderLowStock(); }
        function selectLowStockSize(size) { selectedLowStockSize = size; lowStockViewLevel = 2; renderLowStock(); }
        function backToLowStockSizes() { lowStockViewLevel = 1; selectedLowStockSize = null; renderLowStock(); }

        function renderLowStock() {
            const container = document.getElementById('low-stock-content');
            const crumb = document.getElementById('low-stock-crumb');
            
            if (lowStockInventory.length === 0) {
                container.innerHTML = `<div class="p-8 text-center text-gray-400">No low stock items at this time.</div>`;
                return;
            }

            if (lowStockViewLevel === 0) {
                crumb.innerText = "Select Plant";
                const names = [...new Set(lowStockInventory.map(i => i.COMMONNAME))].sort();
                container.innerHTML = names.map(n => `<div class="drill-item" onclick="selectLowStockName('${n.replace(/'/g, "\\'")}')"><span class="font-bold text-lg">${n}</span><i class="ph-bold ph-caret-right text-gray-300"></i></div>`).join('');
            } 
            else if (lowStockViewLevel === 1) {
                crumb.innerText = selectedLowStockName;
                const namedItems = lowStockInventory.filter(i => i.COMMONNAME === selectedLowStockName);
                const sizes = [...new Set(namedItems.map(i => i.CONTSIZE))].sort();
                let html = `<div class="back-btn" onclick="resetLowStockView()"><i class="ph-bold ph-arrow-left"></i> Back to Names</div><div class="font-bold text-purple-600 mb-4 px-2 text-xl border-b pb-2">${selectedLowStockName}</div>`;
                html += sizes.map(s => {
                    const count = namedItems.filter(i => i.CONTSIZE === s).length;
                    return `<div class="drill-item" onclick="selectLowStockSize('${s}')"><span class="font-bold text-lg">${s} <span class="text-gray-400 text-sm font-normal">(${count})</span></span><i class="ph-bold ph-caret-right text-gray-300"></i></div>`;
                }).join('');
                container.innerHTML = html;
            } 
            else if (lowStockViewLevel === 2) {
                crumb.innerText = `${selectedLowStockName} / ${selectedLowStockSize}`;
                let finalItems = lowStockInventory.filter(i => i.COMMONNAME === selectedLowStockName && i.CONTSIZE === selectedLowStockSize);
                finalItems.sort((a,b) => (a.LOCATIONCODE||"").localeCompare((b.LOCATIONCODE||""), undefined, {numeric: true}));
                container.innerHTML = `<div class="back-btn" onclick="backToLowStockSizes()"><i class="ph-bold ph-arrow-left"></i> Back to Sizes</div>` + finalItems.map(i => generateCard(i, 'low-stock', 'status-purple')).join('');
            }
        }

        function renderSalesOffice() {
            const container = document.getElementById('sales-office-content');
            let officeItems = fullInventory.filter(i => {
                if (!i.DATE_COMPLETED || i.DATE_COMPLETED === "") return false;
                const ptr = parseFloat(i.PTRAVAILABLE) || 0;
                const ss = parseFloat(i.SEASONSUPPLY) || 0;
                return ptr >= (ss * 1.10); 
            });

            if (officeItems.length === 0) {
                container.innerHTML = `<div class="p-8 text-center text-gray-400">No completed Season Sales Notes at this time.</div>`;
                return;
            }

            officeItems.sort((a,b) => (a.LOCATIONCODE||"").localeCompare((b.LOCATIONCODE||""), undefined, {numeric: true}));
            container.innerHTML = officeItems.map(i => generateCard(i, 'sales-office')).join('');
        }

        function renderRequest() {
            const container = document.getElementById('request-content');
            const crumb = document.getElementById('request-crumb');

            let reqItems = fullInventory.filter(i => i.IS_REQUEST === true);
            let reqLowStock = lowStockInventory.filter(i => i.IS_REQUEST === true);
            let combinedReq = [...reqItems, ...reqLowStock];
            
            combinedReq = combinedReq.filter((v,i,a) => a.findIndex(t => (t.DOM_ID === v.DOM_ID)) === i);

            const isReqCompleted = (item) => {
                return (
                    (item.REQ_SALES_NOTE && String(item.REQ_SALES_NOTE).trim() !== "") || 
                    (item.REQ_PHOTO_LINK && String(item.REQ_PHOTO_LINK).trim() !== "") || 
                    (item.REQ_COMMENTS && String(item.REQ_COMMENTS).trim() !== "") ||
                    (item.REQ_SPEC && String(item.REQ_SPEC).trim() !== "") ||
                    (item.REQ_CALIPER && String(item.REQ_CALIPER).trim() !== "") ||
                    (item.REQ_MATCH && String(item.REQ_MATCH).trim() !== "") ||
                    (item.REQ_PICK && String(item.REQ_PICK).trim() !== "")
                );
            };

            let pendingReqs = combinedReq.filter(i => !isReqCompleted(i));
            let completedReqs = combinedReq.filter(i => isReqCompleted(i));

            if (requestViewLevel === 0) {
                crumb.innerText = "Categories";
                container.innerHTML = `
                    <div class="drill-item" onclick="selectRequestCategory('pending')">
                        <span class="font-bold text-lg text-orange-600">All Pending Requests <span class="text-gray-400 text-sm font-normal">(${pendingReqs.length})</span></span>
                        <i class="ph-bold ph-caret-right text-gray-300"></i>
                    </div>
                    <div class="drill-item" onclick="selectRequestCategory('completed')">
                        <span class="font-bold text-lg text-green-600">All Completed Requests <span class="text-gray-400 text-sm font-normal">(${completedReqs.length})</span></span>
                        <i class="ph-bold ph-caret-right text-gray-300"></i>
                    </div>
                    <div class="drill-item" onclick="selectRequestCategory('reps')">
                        <span class="font-bold text-lg text-blue-600">Sales Reps</span>
                        <i class="ph-bold ph-caret-right text-gray-300"></i>
                    </div>
                `;
                return;
            }

            if (requestViewLevel === 1) {
                if (requestFilterMode === 'reps') {
                    crumb.innerText = "Sales Reps";
                    let reps = ["Abbey Burka", "Annette Hancock", "Ben Brown", "Ben Harveson", "Ben Machino", "Brian Hatfield", "Casey Rufener", "Chris Farrow", "Chris Gaydos", "David Brandt", "Ellen Deely", "Jessica Robertson", "Josh Ringleb", "Kevin Effinger", "Nate Douglas", "Toby Brown", "Traci Earle", "Tracey Tapscott", "Troy Lee", "Wes Lugas"];
                    
                    let html = `<div class="back-btn" onclick="requestViewLevel=0; renderRequest()"><i class="ph-bold ph-arrow-left"></i> Back to Categories</div>`;
                    
                    reps.forEach(rep => {
                        let parts = rep.toUpperCase().split(' ');
                        let count = combinedReq.filter(i => {
                            let matchStr = (i.REQUESTED_BY || i.SALESREP || i.SALESREPNAME || i['SALES REP'] || i.ASSIGNEDTO || "").toUpperCase();
                            return matchStr.includes(parts[0]) && matchStr.includes(parts[1]);
                        }).length;
                        
                        html += `<div class="drill-item" onclick="selectRequestRep('${rep}')"><span class="font-bold text-lg">${rep} <span class="text-gray-400 text-sm font-normal">(${count})</span></span><i class="ph-bold ph-caret-right text-gray-300"></i></div>`;
                    });
                    container.innerHTML = html;
                    return;
                } else {
                    crumb.innerText = requestFilterMode === 'pending' ? "Pending" : "Completed";
                    let displayItems = requestFilterMode === 'pending' ? pendingReqs : completedReqs;

                    displayItems.sort((a,b) => (a.LOCATIONCODE||"").localeCompare((b.LOCATIONCODE||""), undefined, {numeric: true}));

                    let html = `<div class="back-btn" onclick="requestViewLevel=0; renderRequest()"><i class="ph-bold ph-arrow-left"></i> Back to Categories</div>`;
                    
                    if (displayItems.length === 0) {
                        html += `<div class="p-8 text-center text-gray-400">No ${requestFilterMode} requests at this time.</div>`;
                    } else {
                        let colorClass = requestFilterMode === 'pending' ? 'status-orange' : 'status-green';
                        html += displayItems.map(i => generateCard(i, 'request', colorClass)).join('');
                    }
                    container.innerHTML = html;
                    return;
                }
            }

            if (requestViewLevel === 2 && requestFilterMode === 'reps') {
                crumb.innerText = `${selectedReqRep}`;
                
                let parts = selectedReqRep.toUpperCase().split(' ');
                let repItems = combinedReq.filter(i => {
                    let matchStr = (i.REQUESTED_BY || i.SALESREP || i.SALESREPNAME || i['SALES REP'] || i.ASSIGNEDTO || "").toUpperCase();
                    return matchStr.includes(parts[0]) && matchStr.includes(parts[1]);
                });

                let repPending = repItems.filter(i => !isReqCompleted(i));
                let repCompleted = repItems.filter(i => isReqCompleted(i));

                container.innerHTML = `
                    <div class="back-btn" onclick="requestViewLevel=1; renderRequest()"><i class="ph-bold ph-arrow-left"></i> Back to Sales Reps</div>
                    <div class="drill-item" onclick="selectRepStatus('pending')">
                        <span class="font-bold text-lg text-orange-600">Pending Requests <span class="text-gray-400 text-sm font-normal">(${repPending.length})</span></span>
                        <i class="ph-bold ph-caret-right text-gray-300"></i>
                    </div>
                    <div class="drill-item" onclick="selectRepStatus('completed')">
                        <span class="font-bold text-lg text-green-600">Completed Requests <span class="text-gray-400 text-sm font-normal">(${repCompleted.length})</span></span>
                        <i class="ph-bold ph-caret-right text-gray-300"></i>
                    </div>
                `;
                return;
            }

            if (requestViewLevel === 3 && requestFilterMode === 'reps') {
                crumb.innerText = `${selectedReqRep} / ${selectedReqRepStatus}`;
                
                let parts = selectedReqRep.toUpperCase().split(' ');
                let repItems = combinedReq.filter(i => {
                    let matchStr = (i.REQUESTED_BY || i.SALESREP || i.SALESREPNAME || i['SALES REP'] || i.ASSIGNEDTO || "").toUpperCase();
                    return matchStr.includes(parts[0]) && matchStr.includes(parts[1]);
                });

                let displayItems = selectedReqRepStatus === 'pending' ? repItems.filter(i => !isReqCompleted(i)) : repItems.filter(i => isReqCompleted(i));
                displayItems.sort((a,b) => (a.LOCATIONCODE||"").localeCompare((b.LOCATIONCODE||""), undefined, {numeric: true}));

                let html = `<div class="back-btn" onclick="requestViewLevel=2; renderRequest()"><i class="ph-bold ph-arrow-left"></i> Back to Folders</div>`;
                
                if (displayItems.length === 0) {
                    html += `<div class="p-8 text-center text-gray-400">No ${selectedReqRepStatus} requests for ${selectedReqRep} at this time.</div>`;
                } else {
                    let colorClass = selectedReqRepStatus === 'pending' ? 'status-orange' : 'status-green';
                    html += displayItems.map(i => generateCard(i, 'request', colorClass)).join('');
                }
                container.innerHTML = html;
                return;
            }
        }

        function renderReview() {
            const container = document.getElementById('review-content');
            const crumb = document.getElementById('review-crumb');

            const resSearch = document.getElementById('reserves-search');
            if (resSearch) resSearch.classList.add('hidden'); 

            if (activeReviewTab === 'reserves') {
                if (reservesViewLevel === 0 && resSearch) resSearch.classList.remove('hidden'); 
                
                const term = resSearch ? resSearch.value.toLowerCase() : "";

                let filteredReserves = reservesInventory;
                if (term) {
                    filteredReserves = filteredReserves.filter(i => (i.COMMONNAME || "").toLowerCase().includes(term) || (i.CUSTOMERNAME || "").toLowerCase().includes(term) || (i.SALESREPNAME || "").toLowerCase().includes(term));
                }

                if (filteredReserves.length === 0) {
                    crumb.innerText = "Reserves View";
                    container.innerHTML = `<div class="p-8 text-center text-gray-400">No reserves data available.</div>`;
                    return;
                }

                if (reservesViewLevel === 0) {
                    crumb.innerText = `Reserves / Select Plant (${filteredReserves.length} items)`;
                    const names = [...new Set(filteredReserves.map(i => i.COMMONNAME))].sort();
                    container.innerHTML = names.map(n => `<div class="drill-item" onclick="selectReservesName('${n.replace(/'/g, "\\'")}')"><span class="font-bold text-lg">${n}</span><i class="ph-bold ph-caret-right text-gray-300"></i></div>`).join('');
                    return;
                }

                if (reservesViewLevel === 1) {
                    crumb.innerText = `Reserves / ${selectedReservesName}`;
                    const namedItems = filteredReserves.filter(i => i.COMMONNAME === selectedReservesName);
                    const sizes = [...new Set(namedItems.map(i => i.CONTSIZE))].sort();
                    
                    let html = `<div class="back-btn" onclick="reservesViewLevel=0; renderReview()"><i class="ph-bold ph-arrow-left"></i> Back to Plants</div>`;
                    html += `<div class="font-bold text-[#007a4d] mb-4 px-2 text-xl border-b pb-2">${selectedReservesName}</div>`;
                    
                    html += sizes.map(s => {
                        const count = namedItems.filter(i => i.CONTSIZE === s).length;
                        return `<div class="drill-item" onclick="selectReservesSize('${s}')"><span class="font-bold text-lg">${s} <span class="text-gray-400 text-sm font-normal">(${count})</span></span><i class="ph-bold ph-caret-right text-gray-300"></i></div>`;
                    }).join('');
                    
                    container.innerHTML = html;
                    return;
                }

                if (reservesViewLevel === 2) {
                    crumb.innerText = `Reserves / ${selectedReservesName} (${selectedReservesSize})`;
                    let displayItems = filteredReserves.filter(i => i.COMMONNAME === selectedReservesName && i.CONTSIZE === selectedReservesSize);
                    
                    let html = `<div class="back-btn" onclick="reservesViewLevel=1; renderReview()"><i class="ph-bold ph-arrow-left"></i> Back to Sizes</div>`;
                    
                    html += displayItems.map(item => {
                        let custDisplay = item.CUSTOMERNAME;
                        if (item.CONSIGNEENAME && item.CONSIGNEENAME !== item.CUSTOMERNAME) {
                            custDisplay += ` - ${item.CONSIGNEENAME}`;
                        }
                        
                        return `
                        <div class="drill-item flex-col items-start gap-2" onclick="openDetail('${item.UNIQUE_ID}', 'review')">
                            <div class="flex justify-between w-full items-center">
                                <span class="font-bold text-[15px] text-gray-800 leading-tight pr-4">${custDisplay}</span>
                                <i class="ph-bold ph-caret-right text-gray-300 text-xl flex-shrink-0"></i>
                            </div>
                            <div class="text-xs font-bold text-purple-700 bg-purple-50 border border-purple-200 px-2 py-1 rounded inline-block mt-1">
                                <i class="ph-bold ph-user mr-1"></i>${item.SALESREPNAME}
                            </div>
                        </div>`;
                    }).join('');
                    
                    container.innerHTML = html;
                    return;
                }
            }

            let completedItems = fullInventory.filter(i => i.DATE_COMPLETED && i.DATE_COMPLETED !== "");
            
            if (completedItems.length === 0) {
                container.innerHTML = `<div class="p-8 text-center text-gray-400">No completed tasks to review.</div>`;
                crumb.innerText = "All Caught Up";
                return;
            }

            if (reviewViewLevel === 0) {
                crumb.innerText = `Completed Tasks by User`;
                const users = [...new Set(completedItems.map(i => i.ASSIGNEDTO || "Unassigned"))].sort();
                container.innerHTML = users.map(u => {
                    const count = completedItems.filter(i => (i.ASSIGNEDTO || "Unassigned") === u).length;
                    return `<div class="drill-item" onclick="selectReviewUser('${u}')"><span class="font-bold text-lg">${u} <span class="text-gray-400 text-sm font-normal">(${count})</span></span><i class="ph-bold ph-caret-right text-gray-300"></i></div>`;
                }).join('');
            } else if (reviewViewLevel === 1) {
                crumb.innerText = `Review / ${selectedReviewUser}`;
                let userItems = completedItems.filter(i => (i.ASSIGNEDTO || "Unassigned") === selectedReviewUser);
                userItems.sort((a,b) => (a.LOCATIONCODE||"").localeCompare((b.LOCATIONCODE||""), undefined, {numeric: true}));
                container.innerHTML = `<div class="back-btn" onclick="reviewViewLevel=0; renderReview()"><i class="ph-bold ph-arrow-left"></i> Back to Users</div>` + 
                userItems.map(i => generateCard(i, 'review')).join('');
            }
        }

        function selectReviewUser(u) {
            selectedReviewUser = u;
            reviewViewLevel = 1;
            renderReview();
        }

        function handleDriveSearch() {
            const term = document.getElementById('drive-search').value;
            if (term.length > 0 && driveViewLevel > 0) { driveViewLevel = 0; selectedDriveName = null; selectedDriveSize = null; }
            renderDrive();
        }
        
        function selectDriveName(name) { 
            selectedDriveName = name; 
            driveViewLevel = 1; 
            renderDrive(); 
        }
        
        function selectDriveSize(size) { selectedDriveSize = size; driveViewLevel = 2; renderDrive(); }
        function backToDriveSizes() { driveViewLevel = 1; selectedDriveSize = null; renderDrive(); }
        function resetDriveView() { driveViewLevel = 0; selectedDriveName = null; selectedDriveSize = null; document.getElementById('drive-search').value = ""; renderDrive(); }

        function renderDrive() {
            const container = document.getElementById('drive-content');
            const crumb = document.getElementById('drive-crumb');
            const term = document.getElementById('drive-search').value.toLowerCase();
            
            let filteredItems = fullInventory;
            if (term) { filteredItems = filteredItems.filter(i => (i.COMMONNAME||"").toLowerCase().includes(term) || (i.LOCATIONCODE||"").toLowerCase().includes(term)); }

            if (filteredItems.length === 0) { container.innerHTML = `<div class="p-8 text-center text-gray-400">No items found.</div>`; crumb.innerText = "No Results"; return; }

            if (driveViewLevel === 0) {
                crumb.innerText = `Select Plant (${filteredItems.length} items)`;
                const names = [...new Set(filteredItems.map(i => i.COMMONNAME))].sort();
                container.innerHTML = names.map(n => `<div class="drill-item" onclick="selectDriveName('${n.replace(/'/g, "\\'")}')"><span class="font-bold text-lg">${n}</span><i class="ph-bold ph-caret-right text-gray-300"></i></div>`).join('');
            } 
            else if (driveViewLevel === 1) {
                crumb.innerText = selectedDriveName;
                const namedItems = filteredItems.filter(i => i.COMMONNAME === selectedDriveName);
                const sizes = [...new Set(namedItems.map(i => i.CONTSIZE))].sort();
                let html = `<div class="back-btn" onclick="resetDriveView()"><i class="ph-bold ph-arrow-left"></i> Back to Names</div><div class="font-bold text-[#007a4d] mb-4 px-2 text-xl border-b pb-2">${selectedDriveName}</div>`;
                html += sizes.map(s => {
                    const count = namedItems.filter(i => i.CONTSIZE === s).length;
                    return `<div class="drill-item" onclick="selectDriveSize('${s}')"><span class="font-bold text-lg">${s} <span class="text-gray-400 text-sm font-normal">(${count})</span></span><i class="ph-bold ph-caret-right text-gray-300"></i></div>`;
                }).join('');
                container.innerHTML = html;
            } 
            else if (driveViewLevel === 2) {
                crumb.innerText = `${selectedDriveName} / ${selectedDriveSize}`;
                let finalItems = filteredItems.filter(i => i.COMMONNAME === selectedDriveName && i.CONTSIZE === selectedDriveSize);
                finalItems.sort((a,b) => (a.LOCATIONCODE||"").localeCompare((b.LOCATIONCODE||""), undefined, {numeric: true}));
                container.innerHTML = `<div class="back-btn" onclick="backToDriveSizes()"><i class="ph-bold ph-arrow-left"></i> Back to Sizes</div>` + finalItems.map(i => generateCard(i, 'drive')).join('');
            }
        }

        function renderTeamSelector() {
            document.getElementById('team-selector').classList.remove('hidden');
            document.getElementById('task-tabs-container').classList.add('hidden');
            document.getElementById('task-content').innerHTML = `<div class="p-8 text-center text-gray-400">Select a team member to view their assigned rows.</div>`;
            document.getElementById('task-crumb').innerText = "Admin Team View";

            const targetNames = ["Dylan", "Morgan", "Kayla"];
            let teamHtml = "";
            targetNames.forEach(name => {
                teamHtml += `<div class="p-5 border border-blue-200 bg-blue-50 text-blue-800 rounded-lg text-center font-bold text-lg cursor-pointer" onclick="setTaskUser('${name}')">${name}</div>`;
            });
            document.getElementById('team-selector').innerHTML = teamHtml;
        }

        function setTaskUser(username) {
            taskViewTargetUser = username;
            document.getElementById('team-selector').classList.add('hidden');
            document.getElementById('task-tabs-container').classList.remove('hidden');
            taskViewLevel = 0;
            renderTasks();
        }

        function selectTaskBlock(b) { selectedTaskBlock = b; taskViewLevel = 1; renderTasks(); }
        function selectTaskLoc(l) { selectedTaskLoc = l; taskViewLevel = 2; renderTasks(); }

        function renderTasks() {
            const container = document.getElementById('task-content');
            const crumb = document.getElementById('task-crumb');
            
            let userToView = (currentRole === 'Admin') ? taskViewTargetUser : currentUser;
            let searchName = userToView === 'dylan_collyge' ? 'Dylan' : userToView;

            let myItems = fullInventory.filter(i => String(i.ASSIGNEDTO || "").toLowerCase().includes(searchName.toLowerCase()));

            myItems = myItems.filter(i => {
                if (i.DATE_COMPLETED && i.DATE_COMPLETED !== "") return false;

                const pri = parseFloat(i.PRIORITY);
                if (isNaN(pri) || pri <= 0) return false; 
                
                if (activeTaskTab === 'season') return i.APP_TAB_ASSIGNMENT === 'season';
                if (activeTaskTab === 'location') return i.APP_TAB_ASSIGNMENT === 'location';
                
                return true;
            });

            const displayUser = searchName.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            const tabLabel = (activeTaskTab === 'season') ? 'Season Notes' : 'Location Notes';

            if (myItems.length === 0) {
                container.innerHTML = `<div class="back-btn" onclick="if(currentRole==='Admin'){taskViewTargetUser=null; renderTeamSelector();}"><i class="ph-bold ph-arrow-left"></i> Change User</div><div class="p-8 text-center text-gray-400">No tasks assigned here.</div>`;
                crumb.innerText = `${displayUser} / ${tabLabel}`;
                return;
            }

            if (taskViewLevel === 0) {
                crumb.innerText = `${displayUser} / ${tabLabel} / Blocks`; 
                const blocks = [...new Set(myItems.map(i => i.BLOCKALPHA || "Unassigned"))].sort();
                let html = "";
                if(currentRole === 'Admin') html += `<div class="back-btn" onclick="taskViewTargetUser=null; renderTeamSelector();"><i class="ph-bold ph-arrow-left"></i> Change User</div>`;
                html += blocks.map(b => {
                    const count = myItems.filter(i => (i.BLOCKALPHA || "Unassigned") === b).length;
                    return `<div class="drill-item" onclick="selectTaskBlock('${b}')"><span class="font-bold text-lg">${b} <span class="text-gray-400 text-sm font-normal">(${count})</span></span><i class="ph-bold ph-caret-right text-gray-300"></i></div>`;
                }).join('');
                container.innerHTML = html;
            } 
            else if (taskViewLevel === 1) {
                crumb.innerText = `${displayUser} / ${selectedTaskBlock}`; 
                const blockItems = myItems.filter(i => (i.BLOCKALPHA || "Unassigned") === selectedTaskBlock);
                const locs = [...new Set(blockItems.map(i => getLocPrefix(i.LOCATIONCODE)))].sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
                container.innerHTML = `<div class="back-btn" onclick="taskViewLevel=0; renderTasks()"><i class="ph-bold ph-arrow-left"></i> Back to Blocks</div>` + 
                locs.map(l => {
                    const count = blockItems.filter(i => getLocPrefix(i.LOCATIONCODE) === l).length;
                    return `<div class="drill-item" onclick="selectTaskLoc('${l}')"><span class="font-bold text-lg">${l} <span class="text-gray-400 text-sm font-normal">(${count})</span></span><i class="ph-bold ph-caret-right text-gray-300"></i></div>`;
                }).join('');
            } 
            else if (taskViewLevel === 2) {
                crumb.innerText = `${displayUser} / ${selectedTaskBlock} / ${selectedTaskLoc}`; 
                let items = myItems.filter(i => (i.BLOCKALPHA || "Unassigned") === selectedTaskBlock && getLocPrefix(i.LOCATIONCODE) === selectedTaskLoc);
                items.sort((a,b) => (a.LOCATIONCODE||"").localeCompare((b.LOCATIONCODE||""), undefined, {numeric: true}));
                container.innerHTML = `<div class="back-btn" onclick="taskViewLevel=1; renderTasks()"><i class="ph-bold ph-arrow-left"></i> Back to Locs</div>` + 
                items.map(i => generateCard(i, 'tasks')).join('');
            }
        }

        function applyQuickNote(val, targetInputId) {
            if (!val) return;
            const targetInput = document.getElementById(targetInputId);
            if (targetInput.value.trim() !== "") {
                targetInput.value = (targetInput.value + " " + val).toUpperCase();
            } else {
                targetInput.value = val.toUpperCase();
            }
            if (targetInputId === 'in-sales-desc') {
                document.getElementById('quick-note-select').value = "";
            } else {
                document.getElementById('req-quick-note-select').value = "";
            }
        }

        function openDetail(uniqueId, sourceView) {
            lastView = sourceView;
            
            activeItem = fullInventory.find(i => i.UNIQUE_ID === uniqueId);
            if (!activeItem) activeItem = lowStockInventory.find(i => i.UNIQUE_ID === uniqueId);
            if (!activeItem) activeItem = reservesInventory.find(i => i.UNIQUE_ID === uniqueId); 
            if (!activeItem) return;

            ['view-drive','view-tasks','view-review','view-sales-office','view-low-stock','view-docks','view-request'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById('view-detail').classList.remove('hidden');
            
            const dtabActions = document.getElementById('dtab-actions');
            if (sourceView === 'docks') {
                dtabActions.style.display = 'none';
            } else {
                dtabActions.style.display = '';
            }

            activeItem.SAVED_PHOTO_LINK = activeItem['PHOTO LINK'] || activeItem.PHOTOLINK || activeItem.SAVED_PHOTO_LINK || "";
            activeItem.SAVED_PHOTO_NAME = activeItem['PHOTO NAME'] || activeItem.PHOTONAME || activeItem.SAVED_PHOTO_NAME || "";

            document.getElementById('det-common').innerText = activeItem.COMMONNAME || "--";
            document.getElementById('det-size').innerText = activeItem.CONTSIZE || "--";
            document.getElementById('ov-loc').innerText = activeItem.LOCATIONCODE || "--";
            document.getElementById('ov-avail').innerText = activeItem.PTRAVAILABLE || "0";
            document.getElementById('ov-item').innerText = activeItem.ITEMCODE || "--";
            document.getElementById('ov-lot').innerText = activeItem.LOTCODE || "--";
            document.getElementById('ov-qual').innerText = activeItem.QUALITYCODE || "--";
            document.getElementById('ov-tag').innerText = activeItem.FIELDTAGCOLOR || activeItem['FIELD TAG COLOR'] || "--";
            document.getElementById('ov-season').innerText = activeItem.SEASONSUPPLY || "--";
            document.getElementById('ov-prior').innerText = activeItem.PRIORITY || "--";

            document.getElementById('in-match').value = activeItem.MATCH || activeItem.MATCHPCT || "";
            document.getElementById('in-spec').value = activeItem.SPEC || "";
            document.getElementById('in-pick').value = activeItem.PIC_NOTE || activeItem.PICKNOTE || activeItem.PICK || "";
            document.getElementById('in-sales-desc').value = activeItem.SALES_NOTE || activeItem.SALESNOTE || activeItem.SALESDESC || "";
            
            document.getElementById('req-match').value = activeItem.REQ_MATCH || "";
            document.getElementById('req-spec').value = activeItem.REQ_SPEC || "";
            document.getElementById('req-pick').value = activeItem.REQ_PICK || "";
            document.getElementById('req-sales-desc').value = activeItem.REQ_SALES_NOTE || "";
            document.getElementById('req-comments').value = activeItem.REQ_COMMENTS || ""; 

            const quickContainer = document.getElementById('quick-note-container');
            const quickSelect = document.getElementById('quick-note-select');
            const reqQuickContainer = document.getElementById('req-quick-note-container');
            const reqQuickSelect = document.getElementById('req-quick-note-select');
            
            quickSelect.innerHTML = '<option value="">-- Select a Quick Note --</option>';
            reqQuickSelect.innerHTML = '<option value="">-- Select a Quick Note --</option>';
            
            let cNameClean = String(activeItem.COMMONNAME || "").trim().toUpperCase();
            if (salesNotesDict[cNameClean] && salesNotesDict[cNameClean].length > 0) {
                salesNotesDict[cNameClean].forEach(note => {
                    let opt1 = document.createElement('option');
                    opt1.value = note; opt1.innerText = note;
                    quickSelect.appendChild(opt1);
                    
                    let opt2 = document.createElement('option');
                    opt2.value = note; opt2.innerText = note;
                    reqQuickSelect.appendChild(opt2);
                });
                quickContainer.classList.remove('hidden');
                reqQuickContainer.classList.remove('hidden');
            } else {
                quickContainer.classList.add('hidden');
                reqQuickContainer.classList.add('hidden');
            }

            const caliperSizes = ["7DP", "#7", "#10", "#15", "#25", "#45"];
            if (caliperSizes.includes(activeItem.CONTSIZE)) {
                document.getElementById('container-caliper').classList.remove('hidden');
                document.getElementById('req-container-caliper').classList.remove('hidden');
                document.getElementById('in-caliper').value = activeItem.CALIPER || "";
                document.getElementById('req-caliper').value = activeItem.REQ_CALIPER || "";
            } else {
                document.getElementById('container-caliper').classList.add('hidden');
                document.getElementById('req-container-caliper').classList.add('hidden');
                document.getElementById('in-caliper').value = "";
                document.getElementById('req-caliper').value = "";
            }

            document.getElementById('expand-section').classList.remove('expanded');
            document.getElementById('expand-content').innerHTML = '';

            renderPhotoPreview();
            switchDetailTab('overview');
        }

        function switchDetailTab(tab) {
            document.getElementById('dtab-overview').classList.toggle('active', tab === 'overview');
            document.getElementById('dtab-actions').classList.toggle('active', tab === 'actions');
            document.getElementById('dtab-request').classList.toggle('active', tab === 'request');
            
            document.getElementById('det-overview-content').classList.toggle('hidden', tab !== 'overview');
            document.getElementById('det-actions-content').classList.toggle('hidden', tab !== 'actions');
            document.getElementById('det-request-content').classList.toggle('hidden', tab !== 'request');
            
            activeDetailTab = tab; 
        }

        function goBackFromDetail() {
            document.getElementById('view-detail').classList.add('hidden');
            document.getElementById('view-' + lastView).classList.remove('hidden');
            reRenderCurrentView();
            activeItem = null;
        }

        function toggleExpand() { 
            const section = document.getElementById('expand-section'); 
            if (!section.classList.contains('expanded')) { renderAllFields(); } 
            section.classList.toggle('expanded'); 
        }

        function renderAllFields() {
            if(!activeItem) return;
            const hiddenKeys = ['UNIQUE_ID', 'UNIQUEID', 'ASSIGNEDTO', 'DOM_ID', 'IS_REQUEST', 'REQUESTED_BY']; 
            let html = '<div class="grid grid-cols-1 gap-2">';
            for (const [key, value] of Object.entries(activeItem)) { 
                if(hiddenKeys.includes(key)) continue; 
                html += `<div class="flex justify-between border-b border-gray-200 py-2"><span class="text-xs font-bold text-gray-500 uppercase w-1/3 break-words">${key}</span><span class="text-xs text-gray-800 font-semibold w-2/3 text-right break-words">${value || '-'}</span></div>`; 
            }
            html += '</div>'; 
            document.getElementById('expand-content').innerHTML = html;
        }

        function handlePhotoUpload(input) {
            if(!input.files || input.files.length === 0) return;
            showToast("Processing...", "Compressing image...", false);
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 1024; 
                    const scale = img.width > MAX_WIDTH ? (MAX_WIDTH / img.width) : 1;
                    
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    const base64Data = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
                    const dateStr = new Date().toISOString().split('T')[0];
                    const filename = `${activeItem.COMMONNAME}_${activeItem.CONTSIZE}_${dateStr}.jpg`.replace(/[\/\s,]/g, '_');
                    
                    uploadPhotoToDrive(base64Data, filename);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function uploadPhotoToDrive(base64Data, filename) {
            showToast("Uploading...", "Sending to Google Drive...", false);
            
            let btn = activeDetailTab === 'request' ? document.getElementById('req-btn-save-draft') : document.getElementById('btn-save-complete');
            if (btn) {
                btn.innerText = "UPLOADING...";
                btn.disabled = true;
            }

            let context = "drive"; 
            if (activeDetailTab === 'request') {
                context = "request";
            } else {
                if (lastView === 'drive' || lastView === 'docks') context = "drive";
                else if (lastView === 'tasks') {
                    if (activeTaskTab === 'season') context = "season";
                    if (activeTaskTab === 'location') context = "location";
                } 
                else if (lastView === 'review' || lastView === 'sales-office' || lastView === 'low-stock') context = "request";
            }

            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ type: "image", image: base64Data, mimeType: "image/jpeg", filename: filename, folderContext: context })
            })
            .then(res => res.json())
            .then(data => {
                if (btn) {
                    btn.innerText = (activeDetailTab === 'request') ? "SAVE REQUEST DATA" : "MARK COMPLETE";
                    btn.disabled = false;
                }
                
                if(data.status === 'success') {
                    if (activeDetailTab === 'request') {
                        let links = activeItem.REQ_PHOTO_LINK ? activeItem.REQ_PHOTO_LINK.split(',') : [];
                        let names = activeItem.REQ_PHOTO_NAME ? activeItem.REQ_PHOTO_NAME.split(',') : [];
                        links.push(data.url);
                        names.push(filename);
                        activeItem.REQ_PHOTO_LINK = links.join(',');
                        activeItem.REQ_PHOTO_NAME = names.join(',');
                    } else {
                        let links = activeItem.SAVED_PHOTO_LINK ? activeItem.SAVED_PHOTO_LINK.split(',') : [];
                        let names = activeItem.SAVED_PHOTO_NAME ? activeItem.SAVED_PHOTO_NAME.split(',') : [];
                        links.push(data.url);
                        names.push(filename);
                        activeItem.SAVED_PHOTO_LINK = links.join(',');
                        activeItem.SAVED_PHOTO_NAME = names.join(',');
                    }
                    renderPhotoPreview(); 
                    saveData(false); 
                } else {
                    showToast("Error", "Upload failed.", true);
                }
            })
            .catch(err => {
                if (btn) {
                    btn.innerText = (activeDetailTab === 'request') ? "SAVE REQUEST DATA" : "MARK COMPLETE";
                    btn.disabled = false;
                }
                showToast("Error", "Network connection failed.", true);
            });
        }

        function renderPhotoPreview() {
            const photoDiv = document.getElementById('photo-preview'); 
            const photoList = document.getElementById('photo-list-container');
            const reqPhotoDiv = document.getElementById('req-photo-preview'); 
            const reqPhotoList = document.getElementById('req-photo-list-container');
            
            if (activeItem.SAVED_PHOTO_LINK && activeItem.SAVED_PHOTO_LINK !== "") {
                photoDiv.classList.remove('hidden'); 
                const urls = activeItem.SAVED_PHOTO_LINK.split(','); 
                const names = activeItem.SAVED_PHOTO_NAME ? activeItem.SAVED_PHOTO_NAME.split(',') : []; 
                let phHtml = "";
                urls.forEach((url, i) => {
                    let cleanUrl = url.trim();
                    let match = cleanUrl.match(/(https?:\/\/[^"\s>]+)/);
                    if (match) cleanUrl = match[1];
                    
                    const dispName = names[i] || `Photo ${i+1}`; 
                    if(cleanUrl.startsWith('http')) {
                        phHtml += `
                        <div class="flex items-center gap-3 p-2 bg-white rounded-lg border border-gray-200 shadow-sm">
                            <a href="${cleanUrl}" target="_blank" class="flex-grow flex items-center gap-3">
                                <i class="ph-fill ph-image text-2xl text-blue-500"></i>
                                <div class="flex-grow min-w-0">
                                    <div class="text-xs font-bold text-blue-600 truncate">${dispName}</div>
                                    <div class="text-[10px] text-gray-400">Tap to view</div>
                                </div>
                                <i class="ph-bold ph-arrow-square-out text-gray-300"></i>
                            </a>
                        </div>`;
                    }
                });
                photoList.innerHTML = phHtml; 
            } else { 
                photoDiv.classList.add('hidden'); 
            }

            if (activeItem.REQ_PHOTO_LINK && activeItem.REQ_PHOTO_LINK !== "") {
                reqPhotoDiv.classList.remove('hidden'); 
                const urls = activeItem.REQ_PHOTO_LINK.split(','); 
                const names = activeItem.REQ_PHOTO_NAME ? activeItem.REQ_PHOTO_NAME.split(',') : []; 
                let phHtml = "";
                urls.forEach((url, i) => {
                    let cleanUrl = url.trim();
                    let match = cleanUrl.match(/(https?:\/\/[^"\s>]+)/);
                    if (match) cleanUrl = match[1];

                    const dispName = names[i] || `Req Photo ${i+1}`; 
                    if(cleanUrl.startsWith('http')) {
                        phHtml += `
                        <div class="flex items-center gap-3 p-2 bg-purple-50 rounded-lg border border-purple-200 shadow-sm">
                            <a href="${cleanUrl}" target="_blank" class="flex-grow flex items-center gap-3">
                                <i class="ph-fill ph-image text-2xl text-purple-600"></i>
                                <div class="flex-grow min-w-0">
                                    <div class="text-xs font-bold text-purple-700 truncate">${dispName}</div>
                                    <div class="text-[10px] text-gray-500">Tap to view</div>
                                </div>
                                <i class="ph-bold ph-arrow-square-out text-purple-400"></i>
                            </a>
                        </div>`;
                    }
                });
                reqPhotoList.innerHTML = phHtml; 
            } else { 
                reqPhotoDiv.classList.add('hidden'); 
            }
        }

        function saveData(isComplete = false) {
            let btnDraft = activeDetailTab === 'request' ? document.getElementById('req-btn-save-draft') : document.getElementById('btn-save-draft');
            let btnComp = activeDetailTab === 'request' ? null : document.getElementById('btn-save-complete');
            
            if (isComplete) { 
                if(btnComp) btnComp.innerText = "SAVING..."; 
            } else { 
                if(btnDraft) btnDraft.innerText = "SAVING..."; 
            }
            
            activeItem.MATCH = document.getElementById('in-match').value;
            activeItem.SPEC = document.getElementById('in-spec').value;
            activeItem.CALIPER = document.getElementById('in-caliper').value;
            activeItem.PICK = document.getElementById('in-pick').value;
            activeItem.SALES_NOTE = document.getElementById('in-sales-desc').value.toUpperCase();

            activeItem.REQ_MATCH = document.getElementById('req-match').value;
            activeItem.REQ_SPEC = document.getElementById('req-spec').value;
            activeItem.REQ_CALIPER = document.getElementById('req-caliper').value;
            activeItem.REQ_PICK = document.getElementById('req-pick').value;
            activeItem.REQ_SALES_NOTE = document.getElementById('req-sales-desc').value.toUpperCase();
            activeItem.REQ_COMMENTS = document.getElementById('req-comments').value; 

            const payload = {
                type: "update",
                id: activeItem.UNIQUE_ID,
                match: activeItem.MATCH,
                spec: activeItem.SPEC,
                caliper: activeItem.CALIPER,
                pick: activeItem.PICK,
                salesDesc: activeItem.SALES_NOTE,
                photoLink: activeItem.SAVED_PHOTO_LINK || "", 
                photoName: activeItem.SAVED_PHOTO_NAME || "",
                reqMatch: activeItem.REQ_MATCH,
                reqSpec: activeItem.REQ_SPEC,
                reqCaliper: activeItem.REQ_CALIPER,
                reqPick: activeItem.REQ_PICK,
                reqSalesDesc: activeItem.REQ_SALES_NOTE,
                reqComments: activeItem.REQ_COMMENTS, 
                reqPhotoLink: activeItem.REQ_PHOTO_LINK || "",
                reqPhotoName: activeItem.REQ_PHOTO_NAME || "",
                isComplete: isComplete 
            };

            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if(btnDraft) btnDraft.innerText = (activeDetailTab === 'request') ? "SAVE REQUEST DATA" : "SAVE DRAFT";
                if(btnComp) btnComp.innerText = "MARK COMPLETE";
                
                if(data.status === 'success') {
                    showToast("Success", isComplete ? "Task Completed!" : "Draft saved to Google Sheet.");
                    if (isComplete) {
                        activeItem.DATE_COMPLETED = new Date().toISOString();
                        goBackFromDetail();
                    }
                } else { showToast("Error", data.message, true); }
            })
            .catch(err => {
                if(btnDraft) btnDraft.innerText = (activeDetailTab === 'request') ? "SAVE REQUEST DATA" : "SAVE DRAFT";
                if(btnComp) btnComp.innerText = "MARK COMPLETE";
                showToast("Network Error", "Could not reach server.", true);
            });
        }
    </script>
</body>
</html>
